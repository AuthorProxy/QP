"use strict";Quantumart.QP8.BackendPlUploader=function(n,t){Quantumart.QP8.BackendPlUploader.initializeBase(this);this._container=n.find(".l-pl-uploader-container").first();this._pickupButton=n.find(".pl_upload_button").first();this._pb_cont=n.find(".lop-pbar-container").first();this._progressbar=n.find(".lop-pbar").first();this._field=n.find("input").first();this._folderId=n.data("folder_id");this._extensions=t.extensions;this._resolveName=t.resolveName;this._useSiteLibrary=t.useSiteLibrary;this._getFormScriptOptions=t.getFormScriptOptions.bind(this)};Quantumart.QP8.BackendPlUploader.prototype={_fileList:null,_pickupButton:null,_folderPath:"",_container:null,_progressbar:null,_progress:null,_extensions:null,_filesNames:[],_resolveName:!1,_useSiteLibrary:!1,_libraryEntityId:null,_libraryParentEntityId:null,_uploader:null,set_folderPath:function(n){this._folderPath=n},get_folderPath:function(){return this._folderPath},_checkFileExistence:function(n,t){var i=window.APPLICATION_ROOT_URL+"Library/FileExists/",r=$q.getJsonSync(i,{path:n,name:t});return r.result},_resolveFileName:function(n,t){var i=window.APPLICATION_ROOT_URL+"Library/ResolveFileName/",r=$q.getJsonSync(i,{path:n,name:t});return r.result},_showProgress:function(){this._progress.value(0);this._progress.refresh();this._progress.setText("0%");this._pickupButton.css("display","none");this._pb_cont.css("display","inline-block")},_hideProgress:function(){this._pickupButton.css("display","inline-block");this._pb_cont.css("display","none")},_beforeUploadHandler:function(n){n.settings.multipart_params={destinationUrl:encodeURI(this.get_folderPath())};n.refresh()},_uploadProgressHandler:function(n,t){this._progress.value(t.percent);this._progress.refresh();this._progress.setText(t.name+" "+this._progress.value()+"%");n.refresh()},_fileUploadedHandler:function(n,t,i){var u=JSON.parse(i.response),f,r;u.isError?(this._hideProgress(),window.alert(u.message)):(this._filesNames.push([t.name]),f=new Quantumart.QP8.BackendUploaderEventArgs([t.name]),this.notify(window.EVENT_TYPE_LIBRARY_FILE_UPLOADED,f),n.total.uploaded===n.files.length&&(r=new Quantumart.QP8.BackendEventArgs,r.set_entityTypeCode(this._useSiteLibrary?window.ENTITY_TYPE_CODE_SITE_FILE:window.ENTITY_TYPE_CODE_CONTENT_FILE),r.set_actionTypeCode(window.ACTION_TYPE_CODE_ALL_FILES_UPLOADED),this._useSiteLibrary?r.set_actionCode(window.ACTION_CODE_UPDATE_SITE_FILE):r.set_actionCode(window.ACTION_CODE_UPDATE_CONTENT_FILE),r.set_parentEntityId(this._folderId),this._hideProgress(),this.notify(window.EVENT_TYPE_LIBRARY_ALL_FILES_UPLOADED,r)));n.refresh()},_filesAddedHandler:function(n,t){for(var i,r=[],u=0;u<t.length;u++)i=t[u],i.size===0&&(n.removeFile(i),r.push(i),window.alert($.telerik.formatString(window.PL_UPLOAD_ZERO_SIZE_WARN,i.name))),this._resolveName?i.name=this._resolveFileName(this._folderPath,i.name):this._checkFileExistence(this._folderPath,i.name)&&!window.confirm(String.format(UPLOAD_OVERWRITE_MESSAGE,i.name))&&(n.removeFile(i),r.push(i));r.length<t.length&&(n.start(),this._showProgress(),n.refresh())},initialize:function(){var t=this._getFormScriptOptions.bind(this),n={runtimes:"html5,flash,html4,silverlight",browse_button:this._pickupButton.attr("id"),container:this._container.attr("id"),max_file_size:window.MAX_UPLOAD_SIZE_BYTES+"b",chunk_size:"1mb",url:"/Backend/Upload/UploadChunk",flash_swf_url:"/Backend/Scripts/PlUpload/Moxie.swf",silverlight_xap_url:"/Backend/Scripts/PlUpload/Moxie.xap",filters:{max_img_resolution:{enabled:!1,imageResolution:window.PL_IMAGE_RESOLUTION,prefilterAction:function(){this.imageResolution=t().imgFilterResolution;this.enabled=!!this.imageResolution}}}};this._extensions&&(n.filters.mime_types=[{title:"Allowed files",extensions:this._extensions.split(";.").join(",").replace(".","")}]);this._uploader=new plupload.Uploader(n);this._uploader.bind("BeforeUpload",jQuery.proxy(this._beforeUploadHandler,this));this._uploader.init();this._uploader.bind("FilesAdded",jQuery.proxy(this._filesAddedHandler,this));this._uploader.bind("UploadProgress",jQuery.proxy(this._uploadProgressHandler,this));this._uploader.bind("FileUploaded",jQuery.proxy(this._fileUploadedHandler,this));this._uploader.bind("Error",function(n,t){+t.code==-600?window.alert(String.format(window.HTML_UPLOAD_MAX_SIZE_MESSAGE,t.file.name,Math.ceil(window.MAX_UPLOAD_SIZE_BYTES/1048576*100)/100)):window.alert(String.format(window.PL_UPLOAD_ERROR_REPORT,t.file.name,t.message,t.code));n.refresh()});this._progressbar.backendProgressBar();this._progress=this._progressbar.data("backendProgressBar");this._progress.total(100);this._uploader.refresh();this._container.data("qp_pl_uploader",this)},dispose:function(){this._container=null;this._fileList=null;this._pickupButton=null;this._progressbar=null;this._progress=null;this._extensions=null;this._filesLoadedDuringSession=null;this._pb_cont=null;this._folderId=null;this._uploader.destroy();this._uploader=null}};Quantumart.QP8.BackendPlUploader.registerClass("Quantumart.QP8.BackendPlUploader",Quantumart.QP8.Observable,Quantumart.QP8.IBackendUploader);