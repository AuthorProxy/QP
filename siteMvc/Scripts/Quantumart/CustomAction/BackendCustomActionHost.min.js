var EVENT_TYPE_EXTERNAL_ACTION_EXECUTING="OnExternalActionExecuting";Quantumart.QP8.BackendCustomActionHost=function(n,t,i){Quantumart.QP8.BackendCustomActionHost.initializeBase(this);this._hostId=n;this._options=t;this._manager=i};Quantumart.QP8.BackendCustomActionHost.prototype={_options:null,_hostId:"",_manager:null,initialize:function(){pmrpc.register({publicProcedureName:this._getExecuteActionProcedureName(),procedure:jQuery.proxy(this._onExternalMessageReceived,this),isAsynchronous:!0});jQuery("#"+this._options.iframeElementId).attr("src",this._generateActionUrl())},_onExternalMessageReceived:function(n,t){n.type==Quantumart.QP8.Interaction.ExternalMessageTypes.ExecuteAction?(this._onExecuteActionMessageReceived(n),t(0)):n.type==Quantumart.QP8.Interaction.ExternalMessageTypes.CloseBackendHost?(this._onCloseHostMessageReceived(n),t(0)):n.type==Quantumart.QP8.Interaction.ExternalMessageTypes.OpenSelectWindow?(this._onOpenSelectWindowMessageReceived(n),t(0)):n.type==Quantumart.QP8.Interaction.ExternalMessageTypes.CheckHost&&t(this._onCheckHostMessageReceived(n))},onSelect:function(){var n=this._options.iframeElementId;jQuery("#"+n).css("marginLeft","1px");setTimeout(function(){jQuery("#"+n).css("marginLeft","0px")},0)},_onCheckHostMessageReceived:function(){return BACKEND_VERSION},_onCloseHostMessageReceived:function(n){this._manager.onCloseHostMessageReceived(n)},_onExecuteActionMessageReceived:function(n){var i=$a.getBackendActionByCode(n.data.actionCode),r=new Quantumart.QP8.BackendActionParameters({entityTypeCode:n.data.entityTypeCode,entityId:n.data.entityId,entityName:$o.getEntityName(n.data.entityTypeCode,n.data.entityId,n.data.parentEntityId),parentEntityId:n.data.parentEntityId}),t;r.correct(i);t=$a.getEventArgsFromActionWithParams(i,r);t.set_externalCallerContext(n);$q.toBoolean(n.data.changeCurrentTab,!1)||$q.isNull(n.data.isWindow)||t.set_isWindow($q.toBoolean(n.data.isWindow,t.get_isWindow()));n.data.options.currentContext&&(n.data.options.contextQuery=JSON.stringify($o.getContextQuery(n.data.parentEntityId,n.data.options.currentContext)));t.set_additionalData(n.data.options);t.set_startedByExternal(!0);r=null;i=null;this.notify(EVENT_TYPE_EXTERNAL_ACTION_EXECUTING,t);t=null},_onOpenSelectWindowMessageReceived:function(n){var t=new Quantumart.QP8.BackendEventArgs,i;t.set_isMultipleEntities(n.data.isMultiple);t.set_parentEntityId(n.data.parentEntityId);t.set_entityTypeCode(n.data.entityTypeCode);t.set_actionCode(n.data.selectActionCode);$q.isArray(n.data.selectedEntityIDs)&&!$q.isNullOrEmpty(n.data.selectedEntityIDs)&&(i=jQuery.map(n.data.selectedEntityIDs,function(n){return{Id:n}}),n.data.isMultiple?t.set_entities(i):t.set_entityId(i[0].Id));selectPopupWindowComponent=new Quantumart.QP8.BackendSelectPopupWindow(t,n.data.options);selectPopupWindowComponent.callerCallback=n.data.callerCallback;selectPopupWindowComponent.selectWindowUID=n.data.selectWindowUID;selectPopupWindowComponent.attachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_RESULT_SELECTED,jQuery.proxy(this._popupWindowSelectedHandler,this));selectPopupWindowComponent.attachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_CLOSED,jQuery.proxy(this._popupWindowClosedHandler,this));selectPopupWindowComponent.openWindow();t=null},_popupWindowSelectedHandler:function(n,t,i){this._invokeCallback(Quantumart.QP8.Interaction.BackendEventTypes.EntitiesSelected,{selectedEntityIDs:jQuery.map(i.entities,function(n){return n.Id}),callerCallback:t.callerCallback,selectWindowUID:t.selectWindowUID});this._destroySelectPopupWindow(t)},_popupWindowClosedHandler:function(n,t){this._destroySelectPopupWindow(t)},_destroySelectPopupWindow:function(n){$q.isNull(n)||(n.detachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_RESULT_SELECTED),n.detachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_CLOSED),n.closeWindow(),n.dispose(),this._invokeCallback(Quantumart.QP8.Interaction.BackendEventTypes.SelectWindowClosed,{callerCallback:n.callerCallback,selectWindowUID:n.selectWindowUID}))},get_hostUID:function(){return this._options.hostUID},onExternalCallerContextsUnbinded:function(n){this._invokeCallback(Quantumart.QP8.Interaction.BackendEventTypes.HostUnbinded,n)},onChildHostActionExecuted:function(n){this._invokeCallback(Quantumart.QP8.Interaction.BackendEventTypes.ActionExecuted,n)},_invokeCallback:function(n,t){var i=window.document.getElementById(this._options.iframeElementId),r;i&&i.contentWindow&&(r={},jQuery.extend(r,t),delete r.callerCallback,pmrpc.call({destination:i.contentWindow,publicProcedureName:t.callerCallback,params:[n,r]}));i=null},_getExecuteActionProcedureName:function(){return this._options.hostUID},_generateActionUrl:function(){var n=$q.updateQueryStringParameter(this._options.actionBaseUrl,"hostUID",this._options.hostUID);return this._options.additionalParams&&(n+="&"+jQuery.param(this._options.additionalParams)),n},dispose:function(){pmrpc.unregister(this._getExecuteActionProcedureName());this._manager.removeComponent(this)}};Quantumart.QP8.BackendCustomActionHost.registerClass("Quantumart.QP8.BackendCustomActionHost",Quantumart.QP8.Observable);