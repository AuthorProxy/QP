var EVENT_TYPE_BREAD_CRUMBS_ITEM_CLICK="OnBreadCrumbsItemClick",EVENT_TYPE_BREAD_CRUMBS_ITEM_CTRL_CLICK="OnBreadCrumbsItemCtrlClick";Quantumart.QP8.BackendBreadCrumbs=function(n,t){Quantumart.QP8.BackendBreadCrumbs.initializeBase(this);this._breadCrumbsElementId=n;$q.isObject(t)&&(t.breadCrumbsContainerElementId&&(this._breadCrumbsContainerElementId=t.breadCrumbsContainerElementId),t.documentHost&&(this._documentHost=t.documentHost),t.manager&&(this._manager=t.manager));this._onBreadCrumbsItemClickHandler=jQuery.proxy(this._onBreadCrumbsItemClick,this);this._onGetBreadCrumbsListSuccessHandler=jQuery.proxy(this._onGetBreadCrumbsListSuccess,this);this._onGetBreadCrumbsListErrorHandler=jQuery.proxy(this._onGetBreadCrumbsListError,this)};Quantumart.QP8.BackendBreadCrumbs.prototype={_breadCrumbsElementId:"",_breadCrumbsElement:null,_breadCrumbsItemListElement:null,_breadCrumbsContainerElementId:"",_documentHost:null,_stopDeferredOperations:!1,_addItemsCallback:null,_maxTitleLength:60,ITEM_CLASS_NAME:"item",ITEM_BUSY_CLASS_NAME:"busy",ITEM_SELECTORS:"LI.item",ITEM_WITH_LINK_SELECTORS:"LI.item:has(A)",ITEM_LAST_WITH_LINK_SELECTORS:"LI.item:has(A):last",_onBreadCrumbsItemClickHandler:null,_onGetBreadCrumbsListSuccessHandler:null,_onGetBreadCrumbsListErrorHandler:null,_manager:null,get_manager:function(){return this._manager},set_manager:function(n){this._manager=n},get_breadCrumbsElementId:function(){return this._breadCrumbsElementId},set_breadCrumbsElementId:function(n){this._breadCrumbsElementId=n},get_breadCrumbsElement:function(){return this._breadCrumbsElement},get_breadCrumbsContainerElementId:function(){return this._breadCrumbsContainerElementId},set_breadCrumbsContainerElementId:function(n){this._breadCrumbsContainerElementId=n},initialize:function(){var n=jQuery("#"+this._breadCrumbsElementId),t=null,i=!$q.isNullOrEmpty(n);i||(n=jQuery("<div />",{id:this._breadCrumbsElementId,"class":"breadCrumbs",css:{display:"none"}}));t=n.find("UL:first");$q.isNullOrEmpty(t)&&(t=jQuery("<ul />"));i||(n.append(t),$q.isNullOrWhiteSpace(this._breadCrumbsContainerElementId)?jQuery("BODY:first").append(n):jQuery("#"+this._breadCrumbsContainerElementId).append(n));this._breadCrumbsElement=n.get(0);this._breadCrumbsItemListElement=t.get(0);i||this._attachBreadCrumbsEventHandlers()},_attachBreadCrumbsEventHandlers:function(){var n=jQuery(this._breadCrumbsItemListElement);n.delegate(this.ITEM_WITH_LINK_SELECTORS,"click",this._onBreadCrumbsItemClickHandler).delegate(this.ITEM_WITH_LINK_SELECTORS,"mouseup",this._onBreadCrumbsItemClickHandler);n=null},_detachBreadCrumbsHandlers:function(){var n=jQuery(this._breadCrumbsItemListElement);n.undelegate(this.ITEM_WITH_LINK_SELECTORS,"click",this._onBreadCrumbsItemClickHandler).undelegate(this.ITEM_WITH_LINK_SELECTORS,"mouseup",this._onBreadCrumbsItemClickHandler);n=null},getItems:function(){return jQuery(this._breadCrumbsItemListElement).find(this.ITEM_SELECTORS)},getLastItemButOne:function(){return jQuery(this._breadCrumbsItemListElement).find(this.ITEM_LAST_WITH_LINK_SELECTORS)},getItem:function(n){var t=null;return $q.isObject(n)?$q.toJQuery(n):$q.isString(n)?(t=jQuery("LI[code='"+n+"']",this._breadCrumbsItemListElement),t.length==0&&(t=null),t):void 0},getItemValue:function(n){var t=this.getItem(n),i="";if($q.isNullOrEmpty(t)){alert("Ошибка!");return}return i=t.attr("code"),t=null,i},getItemText:function(n){var t=this.getItem(n),i="";return $q.isNullOrEmpty(t)||(i=jQuery("SPAN.text",t).text()),t=null,i},showBreadCrumbs:function(){var n=jQuery(this._breadCrumbsElement);n.show();n=null},hideBreadCrumbs:function(){var n=jQuery(this._breadCrumbsElement);n.hide();n=null},markBreadCrumbsAsBusy:function(){var n=jQuery(this._breadCrumbsItemListElement);n.addClass(this.ITEM_BUSY_CLASS_NAME);n=null},unmarkBreadCrumbsAsBusy:function(){var n=jQuery(this._breadCrumbsItemListElement);n.removeClass(this.ITEM_BUSY_CLASS_NAME);n=null},addItemsToBreadCrumbs:function(n){var t=this._documentHost;this._addItemsCallback=n;Quantumart.QP8.BackendBreadCrumbs.getBreadCrumbsList(t.get_entityTypeCode(),t.get_entityId(),t.get_parentEntityId(),t.get_actionCode(),this._onGetBreadCrumbsListSuccessHandler,this._onGetBreadCrumbsListErrorHandler)},_onGetBreadCrumbsListError:function(n){this._stopDeferredOperations||($q.processGenericAjaxError(n),$q.callFunction(this._addItemsCallback))},_onGetBreadCrumbsListSuccess:function(n){var t,u,f,i,r,e;if(!this._stopDeferredOperations&&(t=n,!$q.isNull(t))){if(u=t.length,u>0){for(f=jQuery(this._breadCrumbsItemListElement),i=new $.telerik.stringBuilder,r=u-1;r>=0;r--)e=t[r],this._getItemHtml(i,e);f.html(i.string());this._extendItemElements(t);i=null;$q.callFunction(this._addItemsCallback);return}this.removeItemsFromBreadCrumbs(this._addItemsCallback)}},removeItemsFromBreadCrumbs:function(n){var t=jQuery(this._breadCrumbsItemListElement);t.empty();$q.callFunction(n)},_getItemHtml:function(n,t){var i=Quantumart.QP8.BackendBreadCrumbsManager.getInstance().generateItemCode(t.Code,t.ParentId,t.Id);n.cat('<li code="'+$q.htmlEncode(i)+'" class="'+this.ITEM_CLASS_NAME+'"><\/li>\n')},_extendItemElement:function(n,t,i){var r=this.getItem(n),u;$q.isNullOrEmpty(r)||(u=new $.telerik.stringBuilder,u.catIf('\t<a href="javascript:void(0);">',!i).cat('<span class="text"').cat(" title='(").cat(t.Id).cat(") ").cat(t.EntityTypeName).cat(' "').cat($q.htmlEncode(t.Title)).cat('"').cat("'").cat(">").cat(t.EntityTypeName).cat(' "').cat($q.middleCutShort($q.htmlEncode(t.Title),this._maxTitleLength)).cat('"<\/span>').catIf("<\/a>",!i),r.html(u.string()),r.data("entity_type_code",t.Code),r.data("entity_id",t.Id),r.data("entity_name",t.Title),r.data("parent_entity_id",t.ParentId),r.data("action_code",t.ActionCode))},_extendItemElements:function(n){for(var r=Quantumart.QP8.BackendBreadCrumbsManager.getInstance(),h=n.length,t=0;t<n.length;t++){var i=n[t],u=i.Code,f=i.Id,e=i.ParentId,o=r.generateItemCode(u,e,f),s=this.getItem(o);this._extendItemElement(s,i,t==0)}},_onBreadCrumbsItemClick:function(n){var r,i,t;if(n.preventDefault(),r=n.type=="click"&&(n.which==1||n.which==0),i=n.type=="mouseup"&&n.which==2,!(r||i))return!1;t=this.getItemActionEventArgs(n.currentTarget);t&&(n.ctrlKey||n.shiftKey||i?(t.set_context(jQuery.extend({ctrlKey:n.ctrlKey||i},t.get_context())),this.notify(EVENT_TYPE_BREAD_CRUMBS_ITEM_CTRL_CLICK,t)):this.notify(EVENT_TYPE_BREAD_CRUMBS_ITEM_CLICK,t),t=null)},getItemActionEventArgs:function(n){var t=this.getItem(n),u=t.data("action_code"),i,f,r;if(!$q.isNullOrWhiteSpace(u))if(i=$a.getBackendActionByCode(u),i==null)alert($l.Common.ajaxDataReceivingErrorMessage);else if(f=this._documentHost,f)return r=new Quantumart.QP8.BackendActionParameters({entityTypeCode:t.data("entity_type_code"),entityId:t.data("entity_id"),entityName:t.data("entity_name"),parentEntityId:t.data("parent_entity_id")}),r.correct(i),$a.getEventArgsFromActionWithParams(i,r)},dispose:function(){var n,t;this._stopDeferredOperations=!0;Quantumart.QP8.BackendBreadCrumbs.callBaseMethod(this,"dispose");this._documentHost=null;this._manager=null;this._detachBreadCrumbsHandlers();this._breadCrumbsItemListElement&&(n=jQuery(this._breadCrumbsItemListElement),n.empty().remove(),n=null,this._breadCrumbsItemListElement=null);this._breadCrumbsElement&&(t=jQuery(this._breadCrumbsElement),t.empty().remove(),t=null,this._breadCrumbsElement=null);this._onBreadCrumbsItemClickHandler=null;this._onGetBreadCrumbsListSuccessHandler=null;this._onGetBreadCrumbsListErrorHandler=null}};Quantumart.QP8.BackendBreadCrumbs.getBreadCrumbsList=function(n,t,i,r,u,f){var o=CONTROLLER_URL_ENTITY_OBJECT+"GetBreadCrumbsList",s={entityTypeCode:n,entityId:t,parentEntityId:i,actionCode:r},e;if($q.isFunction(u))$q.getJsonFromUrl("GET",o,s,!1,!1,u,f);else return e=null,$q.getJsonFromUrl("GET",o,s,!1,!1,function(n){e=n},function(n){e=null;$q.processGenericAjaxError(n)}),e};Quantumart.QP8.BackendBreadCrumbs.registerClass("Quantumart.QP8.BackendBreadCrumbs",Quantumart.QP8.Observable);