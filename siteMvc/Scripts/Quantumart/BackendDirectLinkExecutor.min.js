var EVENT_TYPE_DIRECT_LINK_ACTION_EXECUTING="OnDirectLinkActionExecuting";Quantumart.QP8.DirectLinkExecutor=function(n,t){Quantumart.QP8.DirectLinkExecutor.initializeBase(this);this._currentCustomerCode=n;this._urlLinkParams=t;this._uid=(new Date).getTime()};Quantumart.QP8.DirectLinkExecutor.prototype={LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG:"Quantumart.QP8.DirectLinkExecutor.BackendIsAllreadyExists",LOCAL_STORAGE_KEY_OBSERVABLE_ITEM:"Quantumart.QP8.DirectLinkExecutor.DirectLinkData",LOCAL_STORAGE_KEY_INSTANCE_EXISTING_RESPONSE:"Quantumart.QP8.DirectLinkExecutor.ExistingRespose",LOCAL_STORAGE_KEY_SENT_KEY_NAME:"Quantumart.QP8.DirectLinkExecutor.LastKeyName",_currentCustomerCode:null,_urlLinkParams:null,_imFirst:!1,_uid:null,_onDirectLinkOpenRequested:function(n){var t,i;$q.isNullOrEmpty(n.key)&&(t=window.localStorage.getItem(this.LOCAL_STORAGE_KEY_SENT_KEY_NAME),t&&(n.key=t,n.newValue=window.localStorage.getItem(t)));n.key==this.LOCAL_STORAGE_KEY_OBSERVABLE_ITEM&&$q.isString(n.newValue)?(i=jQuery.parseJSON(n.newValue),this._executeAction(i,!0)):n.key==this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG&&$q.isInt(n.newValue)&&n.newValue!=this._uid&&this._send(this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_RESPONSE,"true")},_onDirectLinkOpenRequestedHandler:null,_executeAction:function(n,t){var i,f,r,u;n&&($q.isNullOrEmpty(n.customerCode)&&(n.customerCode=this._currentCustomerCode),n.customerCode.toLowerCase()==this._currentCustomerCode.toLowerCase()?(!t||confirm($l.BackendDirectLinkExecutor.OpenDirectLinkConfirmation))&&(i=$a.getBackendActionByCode(n.actionCode),i?(f=i.ActionType.Code,r=new Quantumart.QP8.BackendActionParameters({entityTypeCode:n.entityTypeCode,entityId:n.entityId,parentEntityId:n.parentEntityId}),r.correct(i),u=$a.getEventArgsFromActionWithParams(i,r),this.notify(EVENT_TYPE_DIRECT_LINK_ACTION_EXECUTING,u),r=null,u=null):alert($l.Common.ajaxDataReceivingErrorMessage)):confirm($l.BackendDirectLinkExecutor.ReloginRequestConfirmation)&&(window.location.href=CONTROLLER_URL_LOGON+"LogOut/?"+jQuery.param(n)),t&&window.localStorage.removeItem(this.LOCAL_STORAGE_KEY_OBSERVABLE_ITEM))},_send:function(n,t){window.localStorage.removeItem(this.LOCAL_STORAGE_KEY_SENT_KEY_NAME);window.localStorage.setItem(n,t);"onstorage"in document&&window.localStorage.setItem(this.LOCAL_STORAGE_KEY_SENT_KEY_NAME,n)},_instanceExistenceCheck:function(){var t=new jQuery.Deferred,i=!$q.isNullOrEmpty(window.localStorage.getItem(this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG)),n;return i===!0?(this._send(this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG,this._uid),n=this,setTimeout(function(){var i=$q.toBoolean(window.localStorage.getItem(n.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_RESPONSE),!1);window.localStorage.removeItem(n.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_RESPONSE);t.resolveWith(n,[i])},500)):t.resolveWith(this,[!1]),t.promise()},_registerInstance:function(){this._send(this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG,"true")},_unregisterInstance:function(){window.localStorage.removeItem(this.LOCAL_STORAGE_KEY_INSTANCE_EXISTING_FLAG)},ready:function(n){this._instanceExistenceCheck().done(function(t){if(t)this._imFirst=!1,this._urlLinkParams?confirm($l.BackendDirectLinkExecutor.WillBeRunInFirstInstanceConfirmation)&&this._send(this.LOCAL_STORAGE_KEY_OBSERVABLE_ITEM,JSON.stringify(this._urlLinkParams)):alert($l.BackendDirectLinkExecutor.InstanceIsAllreadyOpen);else{this._imFirst=!0;this._registerInstance();this._send(this.LOCAL_STORAGE_KEY_OBSERVABLE_ITEM,"");this._onDirectLinkOpenRequestedHandler=jQuery.proxy(this._onDirectLinkOpenRequested,this);window.addEventListener?window.addEventListener("storage",this._onDirectLinkOpenRequestedHandler,!1):document.attachEvent&&document.attachEvent("onstorage",this._onDirectLinkOpenRequestedHandler);var i=!1;this._urlLinkParams&&(i=!0);$q.isFunction(n)&&n(i);i===!0&&this._executeAction(this._urlLinkParams,!1)}})},dispose:function(){this._imFirst&&("onstorage"in document||this._unregisterInstance(),window.localStorage.removeItem(this.LOCAL_STORAGE_KEY_OBSERVABLE_ITEM),window.removeEventListener?window.removeEventListener("storage",this._onDirectLinkOpenRequestedHandler):document.detachEvent&&document.detachEvent("onstorage",this._onDirectLinkOpenRequestedHandler))}};Quantumart.QP8.DirectLinkExecutor.registerClass("Quantumart.QP8.DirectLinkExecutor",Quantumart.QP8.Observable);