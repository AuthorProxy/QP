Quantumart.QP8.ImageCropResizeClient=Quantumart.QP8.ImageCropResizeClient||{};Quantumart.QP8.ImageCropResizeClient.Cache=Quantumart.QP8.ImageCropResizeClient.Cache||{},function(n,t){"use strict";var gt={sourceImageUrl:"",resultImageFolder:"",crop:{height:100,width:100,left:0,top:0},allowResizeCropArea:!0,allowFileRewrite:!0,checkFileNameActionUrl:APPLICATION_ROOT_URL+"Library/CheckForCrop/",cropResizeActionUrl:APPLICATION_ROOT_URL+"Library/Crop/",resizeRange:{max:3,min:.1},onCompleteCallback:function(){Sys.Debug.trace("imgCropResize: finished")}},ni="<fieldset class='crop'>                <legend>"+$l.Crop.selection+"<\/legend>                <dl>                    <dt>"+$l.Crop.left+"<\/dt>                    <dd>                        <span class='selection-x'><\/span>                    <\/dd>                <\/dl>                <dl>\t\t\t\t<dl>                    <dt>"+$l.Crop.top+"<\/dt>                    <dd>                        <span class='selection-y' />                    <\/dd>                <\/dl>                <dl>                    <dt>"+$l.Crop.width+"<\/dt>                    <dd>                        <span class='selection-width' />                    <\/dd>                <\/dl>                <dl>                    <dt>"+$l.Crop.height+"<\/dt>                    <dd>                        <span class='selection-height' />                    <\/dd>                <\/dl>            <\/fieldset>",ti="<fieldset class='slider'>                <legend>"+$l.Crop.changeSize+"<\/legend>                <div>                    <span class='slider-value'>x1<\/span>                    <div class='right'>                        <div class='nouislider' />                    <\/div>                <\/div>            <\/fieldset>",ii="<form class='saveForm'><fieldset class='save'>                <legend>"+$l.Crop.save+"<\/legend>                <dl class='row'>                    <dd class='save-items'>                        <input class='button-save' type='button' value='"+$l.Crop.save+"' />                    <\/dd>                <\/dl>            <\/fieldset><\/form>",ri="<div class='save-overwrite'>                            <ul class='formItem'>                                <li>                                    <input id='overwrite_0' class='image-overwrite' name='overwrite' checked='checked' type='radio' value='true' />                                    <label for='overwrite_0'>"+$l.Crop.overwrite+"<\/label>                                <\/li>                                <li>                                    <input id='overwrite_1' class='image-save-copy' name='overwrite' type='radio' value='false' />                                    <label for='overwrite_1'>"+$l.Crop.saveAs+"<\/label>                                <\/li>                                <li>                                    <input class='filename-input' type='text' disabled='disabled' />                                <\/li>                            <\/ul>                        <\/div>",ui="<div class='save-overwrite'>                            <ul class='formItem'>                                <li>                                    <label>"+$l.Crop.saveAs+"<\/label>                                <\/li>                                <li>                                    <input class='filename-input' type='text' />                                <\/li>                            <\/ul>                        <\/div>",fi="<fieldset class='errorsContainer' style='display: none;'>                <legend>"+$l.Crop.errors+"<\/legend>                <ul class='errors'>                <\/ul>            <\/fieldset>",i=null,u=null,r=null,p=null,w=null,b=null,k=null,s=null,v=null,d=null,lt=null,g=null,nt=$l.Crop.defaultErrorMessage,f=null,tt=null,it=null,rt=null,at=null,c=null,ut=null,e=null,h=null,ft=null,et=null,o=null,ot=null,vt=0,yt=0,pt=function(n){setTimeout(function(){s!=null&&(n.width!=i.crop.width||n.height!=i.crop.height)&&(s.setSelection(n.x1,n.y1,n.x1+i.crop.width,n.y2+i.crop.height),s.update())},0)},wt=function(n){var t,r,u,f,e;g.text("x"+n);t=vt*n;r=yt*n;i.allowResizeCropArea?bt(t):(u=t-i.crop.width,f=r-i.crop.height,u>0&&f>0&&bt(t),e=s.getSelection(),pt(e))},bt=function(n){e[0].style.width=Math.floor(n)+"px";ct(e);setTimeout(s.update(),0)},ei=function(){lt=f.noUiSlider({range:{min:i.resizeRange.min,"50%":1,max:i.resizeRange.max},start:1});f.on({slide:function(n,t){wt(t)},set:function(n,t){g.text("x"+t);wt(t)}});f.on("mousewheel DOMMouseScroll",function(t){var i=t.originalEvent,e=i&&(i.wheelDelta||i.detail&&-i.detail),r,f,u;e&&(t.preventDefault(),r=parseFloat(n(this).val()),f=1,f*=e<0?r<1?-.25:-.5:r<1?.25:.5,u=r+f,u>=0&&u<=3.5&&n(this).val(u,{set:!0}))})},oi=function(){var t={persistent:!i.allowResizeCropArea,instance:!0,resizable:i.allowResizeCropArea,movable:!0,x1:i.crop.left,y1:i.crop.top,x2:i.crop.left+i.crop.width,y2:i.crop.top+i.crop.height,parent:u.find(".image"),onSelectChange:function(n,t){i.allowResizeCropArea||pt(t);kt(t,i.allowResizeCropArea)},onInit:function(n,t){kt(t,!0)}};i.allowResizeCropArea||n.extend(t,{minHeight:i.crop.height,minWidth:i.crop.width,maxHeight:i.crop.height,maxWidth:i.crop.width});s=ot.imgAreaSelect(t)},kt=function(n,t){setTimeout(function(){isNaN(n.width)&&isNaN(n.height)||n.width==0&&n.height==0?(p.text(""),w.text(""),b.text(""),k.text("")):(t&&(b.text(n.width),k.text(n.height)),p.text(Math.max(n.x1,0)),w.text(Math.max(n.y1,0)))},0)},si=function(){oi();ei()},ct=function(t){if(h&&t){var i=10,e=h.width()+t.outerWidth()+i*3,o=Math.max(h.height(),t.outerHeight()+i)+i*2,r=Math.min(e,n(window).width()*.8),f=Math.min(o,n(window).height()*.8),s=r-h.width()-i,c=f-i;u.find(".t-content").css("width",r+"px");u.find(".t-content").css("height",f+"px");u.find(".image").css("width",s+"px");u.find(".image").css("height",c+"px")}},hi=function(){o=n.telerik.window.create({title:$l.Crop.title,actions:["Close"],modal:!0,resizable:!1,draggable:!0,scrollable:!0,onOpen:function(){},onClose:function(){o.destroy()},onActivate:function(){},onLoad:function(){}}).data("tWindow");u=jQuery(o.element);u.addClass("imgCropResizeWindow");et.appendTo(u.find(".t-content"))},ci=function(){r=u},li=function(){p=r.find(".selection-x");w=r.find(".selection-y");b=r.find(".selection-width");k=r.find(".selection-height");g=r.find(".slider-value");v=r.find(".button-save");d=r.find(".saveForm");f=r.find(".nouislider");tt=r.find(".errors");it=r.find(".errorsContainer");rt=r.find(".image-save-copy");at=r.find(".image-overwrite");c=r.find(".filename-input");ut=r.find("input[name=overwrite]:radio");ot=r.find("img.img")},ai=function(n,t){return t.indexOf(n,t.length-n.length)!==-1},vi=function(n){return n.substring(0,n.lastIndexOf("/"))},yi=function(n){var t=n.lastIndexOf(".");return t==-1?"":n.substr(t,n.length-t)},y=function(){tt.empty();it.hide()},pi=function(){if(!i.sourceImageUrl)throw new Error("imgCropResize: parameter 'sourceImageUrl' not set");if(!i.checkFileNameActionUrl)throw new Error("imgCropResize: parameter 'checkFileNameActionUrl' not set");if(!i.cropResizeActionUrl)throw new Error("imgCropResize: parameter 'cropResizeActionUrl' not set");if(i.resizeRange.min<0||i.resizeRange.max<0)throw new Error("imgCropResize: resize range must be positive");if(i.resizeRange.min>i.resizeRange.max)throw new Error("imgCropResize: resizeRange.min must be less than resizeRange.max");},wi=function(){return Quantumart.QP8.ImageCropResizeClient.Cache[i.sourceImageUrl]},bi=function(){delete Quantumart.QP8.ImageCropResizeClient.Cache[i.sourceImageUrl]},ki=function(){var n=ht();n.width&&n.height&&(Quantumart.QP8.ImageCropResizeClient.Cache[i.sourceImageUrl]={crop:{top:n.top,left:n.left,width:n.width,height:n.height}})},di=function(t){n.ajax(i.checkFileNameActionUrl,{data:{targetFileUrl:t},type:"POST",dataType:"json"}).success(function(n){if(n.ok)dt();else{var t=n.message||nt;a([t])}}).fail(function(){a([nt])})},dt=function(){var t=ht();t=JSON.stringify(t);n.ajax(i.cropResizeActionUrl,{contentType:"application/json",data:t,type:"POST",dataType:"json"}).success(function(n){if(n.ok)typeof i.onCompleteCallback=="function"&&(st()==l.saveAs?ki():bi(),i.onCompleteCallback());else{var t=n.message||nt;a([t])}}).fail(function(){a([nt])})},gi=function(){var r,t;et=n("<div class='imgCropResize content-container' />");h=n(" <div class='aside'><\/div>");ft=n("<div class='image'/>");r=i.sourceImageUrl+"?t="+(new Date).getTime();e=n("<img class='img' src='"+r+"' alt='изображение' />");e.load(function(){vt=e.width();yt=e.height();ct(n(this));o.center()});e.appendTo(ft);t=n(ii);i.allowFileRewrite?t.find(".save-items").prepend(n(ri)):t.find(".save-items").prepend(n(ui));et.append(h.append(n(ni),n(ti),t,n(fi)),h,ft)},l={overwrite:"overwrite",saveAs:"saveAs"},st=function(){return!i.allowFileRewrite||rt.attr("checked")?l.saveAs:l.overwrite},nr=function(){var n=st();return n==l.saveAs&&!c.val()?(a([$l.Crop.enterFileName]),!1):(y(),!0)},tr=function(){v.click(function(){if(nr())if(y(),st()==l.overwrite)dt();else{var n=ht();di(n.targetFileUrl)}});d.submit(function(n){return n.preventDefault(),v.trigger("click"),!1});ut.change(function(){var n=rt.attr("checked");n?c.removeAttr("disabled"):c.attr("disabled","disabled")})};t.create=function(t){return i={},n.extend(i,gt),n.extend(i,t),n.extend(i,wi()),pi(),gi(),hi(),ci(),li(),si(),tr(),{type:"Quantumart.QP8.ImageCropResizeClient",displayErrors:a,getOptions:ht,openWindow:ir,closeWindow:rr,dispose:ur,parameters:i,window:u}};var a=function(t){y();for(var i in t)tt.append(n("<li>"+t[i]+"<\/li>"));it.show();ct(e)},ht=function(){var u="",o=st()==l.overwrite,t,e,r;return o?u=i.sourceImageUrl:(t=n.trim(c.val()),t!=""&&t.lastIndexOf(".")==-1&&(t=t+yi(i.sourceImageUrl)),u=i.resultImageFolder?ai("/",i.resultImageFolder)?i.resultImageFolder+t:"/"+t:vi(i.sourceImageUrl)+t),e={overwriteFile:o,targetFileUrl:u,sourceFileUrl:i.sourceImageUrl,resize:+f.val()},r=s.getSelection(),(r.width||r.height)&&n.extend(e,{left:Math.max(r.x1,0),top:Math.max(r.y1,0),width:r.width,height:r.height}),e},ir=function(){o?(o.center(),y()):console.log("item was not created or has been deleted")},rr=function(){y();o.close()},ur=function(){ot.imgAreaSelect("destroy");ot=null;o.destroy();u=null;r=null;p=null;w=null;b=null;k=null;s=null;v.off("click");d.off("submit");v=null;d=null;f.off("slide");f.off("_setSize");f.off("mousewheel DOMMouseScroll");f=null;lt=null;g=null;tt=null;it=null;rt=null;at=null;c=null;ut.off("change");ut=null;e=null;h=null;ft=null;et=null;o=null;i=null;delete this.displayErrors;delete this.getOprions;delete this.openWindow;delete this.closeWindow;delete this.dispose;delete this.parameters;delete this.window}}(jQuery,Quantumart.QP8.ImageCropResizeClient);