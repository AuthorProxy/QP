var EVENT_TYPE_AUTO_SAVER_ACTION_EXECUTING="OnAutoSaverRestoringActionExecuting";Quantumart.QP8.EntityEditorAutoSaver=function(n){Quantumart.QP8.EntityEditorAutoSaver.initializeBase(this);n&&(n.currentCustomerCode&&(this._currentCustomerCode=n.currentCustomerCode),n.currentUserId&&(this._currentUserId=n.currentUserId));this.isRun=!1;this.restoring=!1;this._keyPrefix=Quantumart.QP8.EntityEditorAutoSaver._keyNameRoot+"."+this._currentCustomerCode+"."+this._currentUserId};Quantumart.QP8.EntityEditorAutoSaver._keyNameRoot="Quantumart.QP8.EntityEditorAutoSaver";Quantumart.QP8.EntityEditorAutoSaver.prototype={_restoringStateCount:0,isRun:!1,restoring:!1,_currentCustomerCode:"",_currentUserId:"",_keyPrefix:"",start:function(){this.isRun=!0;this.restoring=!1},restore:function(){var n,t;this.isRun=!1;this.restoring=!0;var u=new RegExp("^"+this._keyPrefix),i=[],r=[];for(n in localStorage)u.test(n)&&(i.push(n),r.push(jQuery.parseJSON(localStorage.getItem(n))));for(t=0;t<i.length;t++)localStorage.removeItem(i[t]);this._checkForRestoring(r).done(jQuery.proxy(function(n){var r,i;if(n.length>0&&confirm($l.EntityEditorAutoSaver.restoreConfirmationRequest))for(this._restoringStateCount=n.length,r=0;r<n.length;r++){var t=n[r],u=$a.getBackendActionByCode(t.actionCode),f=new Quantumart.QP8.BackendActionParameters({entityTypeCode:t.entityTypeCode,entityId:t.entityId,parentEntityId:t.parentEntityId});f.correct(u);i=$a.getEventArgsFromActionWithParams(u,f);i.set_additionalData({restoring:!0,initFieldValues:t.fieldValues,disabledFields:t.disabledFields,hideFields:t.hideFields});f=null;u=null;i._isWindow=!1;this.notify(EVENT_TYPE_AUTO_SAVER_ACTION_EXECUTING,i);i=null}else this._restoringStateCount=0,this.start()},this)).fail(jQuery.proxy(function(){this._restoringStateCount=0;this.start()},this))},onEntityEditorReady:function(n){var t=Quantumart.QP8.BackendEntityEditor.getComponent(jQuery("#"+n));t&&t.allowAutoSave()&&(this.restoring===!0||t.isFieldsValid()!==!0)&&(localStorage.setItem(this._createKey(n),JSON.stringify(this._getEditorComponentState(n))),this.restoring&&(this._restoringStateCount--,this._restoringStateCount<1&&this.start()))},onEntityEditorDisposed:function(n){this.isRun===!0&&localStorage.removeItem(this._createKey(n))},onFieldChanged:function(n){var i,r,t,u;this.isRun===!0&&(i=Quantumart.QP8.BackendEntityEditor.getComponent(jQuery("#"+n.documentWrapperElementId)),i&&i.allowAutoSave()&&(r=this._createKey(n.documentWrapperElementId),t=jQuery.parseJSON(localStorage.getItem(r)),t?(u=jQuery.grep(t.fieldValues,function(t){return t.fieldName===n.fieldName})[0],u?u.value=n.value:t.fieldValues.push({fieldName:n.fieldName,value:n.value})):t=this._getEditorComponentState(n.documentWrapperElementId),t.contextQuery=i.get_contextQuery(),localStorage.setItem(r,JSON.stringify(t))))},onAllFieldInvalidate:function(n){var t,i,r;this.isRun===!0&&(t=Quantumart.QP8.BackendEntityEditor.getComponent(jQuery("#"+n)),t&&t.allowAutoSave()&&(i=this._createKey(n),r=jQuery.parseJSON(localStorage.getItem(i)),r?localStorage.setItem(i,JSON.stringify(this._getEditorComponentState(n))):localStorage.setItem(this._createKey(n),JSON.stringify(this._getEditorComponentState(n)))))},_getEditorComponentState:function(n){var t=Quantumart.QP8.BackendEntityEditor.getComponent(jQuery("#"+n));if(t)return{wrapperElementId:n,recordId:(new Date).getTime(),actionCode:t.get_actionCode(),entityTypeCode:t.get_entityTypeCode(),entityId:t.get_entityId(),parentEntityId:t.get_parentEntityId(),modifiedDateTime:t.get_modifiedDateTime(),contextQuery:t.get_contextQuery(),fieldValues:t.get_fieldValues(),disableFields:t.get_disabledFields(),hideFields:t.get_hideFields()}},_checkForRestoring:function(n){var t=new jQuery.Deferred,i;return $q.isArray(n)&&!$q.isNullOrEmpty(n)?(i={recordHeaders:JSON.stringify(jQuery.map(n,function(n){return{RecordId:n.recordId,ActionCode:n.actionCode,EntityTypeCode:n.entityTypeCode,EntityId:n.entityId,ParentEntityId:n.parentEntityId,ModifiedTicks:n.modifiedDateTime}}))},$q.getJsonFromUrl("POST",CONTROLLER_URL_ENTITY_OBJECT+"AutosaveRestoringCheck",i,!0,!1).done(function(i){i.success?$q.isNullOrEmpty(i.approvedRecordIDs)?t.resolve([]):t.resolve(jQuery.grep(n,function(n){return _.indexOf(i.approvedRecordIDs,n.recordId)>-1})):(alert(i.Text),t.reject())}).fail(function(n){$q.processGenericAjaxError(n);t.reject()})):t.resolve([]),t.promise()},_createKey:function(n){return this._keyPrefix+"."+n},dispose:function(){}};Quantumart.QP8.EntityEditorAutoSaver.registerClass("Quantumart.QP8.EntityEditorAutoSaver",Quantumart.QP8.Observable);