Quantumart.QP8.BackendFileField=function(n,t,i){Quantumart.QP8.BackendFileField.initializeBase(this);this._fileFieldElementId=n;this._fileWrapperElementId=t;$q.isNull(i)||(i.entityId&&(this._entityId=i.entityId),$q.isNull(i.allowFileUpload)||(this._allowFileUpload=i.allowFileUpload),i.libraryPath&&(this._libraryPath=i.libraryPath),i.libraryUrl&&(this._libraryUrl=i.libraryUrl),$q.isNull(i.renameMatched)||(this._renameMatched=i.renameMatched),$q.isNull(i.isImage)||(this._isImage=i.isImage),$q.isNull(i.isVersion)||(this._isVersion=i.isVersion),i.libraryEntityId&&(this._libraryEntityId=i.libraryEntityId),i.libraryParentEntityId&&(this._libraryParentEntityId=i.libraryParentEntityId),$q.isNull(i.useSiteLibrary)||(this._useSiteLibrary=i.useSiteLibrary),i.subFolder&&(this._subFolder=i.subFolder),i.uploaderType&&(this._uploaderType=i.uploaderType));this._onPreviewButtonClickHandler=jQuery.proxy(this._onPreviewButtonClick,this);this._onDownloadButtonClickHandler=jQuery.proxy(this._onDownloadButtonClick,this);this._onLibraryButtonClickHandler=jQuery.proxy(this._onLibraryButtonClick,this)};Quantumart.QP8.BackendFileField.prototype={_fileFieldElementId:"",_fileFieldElement:null,_fileWrapperElementId:"",_fileWrapperElement:null,_browseButtonElement:null,_previewButtonElement:null,_libraryButtonElement:null,_previewWindowComponent:null,_downloadButtonElement:null,_entityId:0,_allowFileUpload:!1,_libraryPath:"",_libraryUrl:"",_renameMatched:!1,_isImage:!1,_isVersion:!1,_subFolder:"",_useSiteLibrary:!1,_libraryEntityId:0,_libraryParentEntityId:0,_uploaderType:Quantumart.QP8.Enums.UploaderType.Silverlight,_selectPopupWindowComponent:null,_uploaderComponent:null,_uploaderSubFolder:"",PREVIEW_BUTTON_CLASS_NAME:"previewButton",BROWSE_BUTTON_CLASS_NAME:"browseButton",DOWNLOAD_BUTTON_CLASS_NAME:"downloadButton",LIBRARY_BUTTON_CLASS_NAME:"libraryButton",get_fileFieldElementId:function(){return this._fileFieldElementId},set_fileFieldElementId:function(n){this._fileFieldElementId=n},get_fileFieldElement:function(){return this._fileFieldElement},get_fileWrapperElementId:function(){return this._fileWrapperElementId},set_fileWrapperElementId:function(n){this._fileWrapperElementId=n},get_fileWrapperElement:function(){return this._fileWrapperElement},get_entityId:function(){return this._entityId},set_entityId:function(n){this._entityId=n},get_allowFileUpload:function(){return this._allowFileUpload},set_allowFileUpload:function(n){this._allowFileUpload=n},get_libraryPath:function(){return this._libraryPath},set_libraryPath:function(n){this._libraryPath=n},get_renameMatched:function(){return this._renameMatched},set_renameMatched:function(n){this._renameMatched=n},get_isImage:function(){return this._isImage},set_isImage:function(n){this._isImage=n},get_isVersion:function(){return this._isVersion},set_isVersion:function(n){this._isVersion=n},updateUploader:function(n){var t,i;this._uploaderSubFolder=n;t=jQuery(this._fileFieldElement);this._uploaderSubFolder?t.attr("placeholder",this._getFileFieldSubFolder()):(t.removeAttr("placeholder"),this._uploaderSubFolder="");i=this._libraryPath;this._uploaderSubFolder&&(i+="\\"+this._uploaderSubFolder);this._uploaderComponent&&this._uploaderComponent.set_folderPath(i)},_getFileFieldSubFolder:function(){var n=this._uploaderSubFolder;return n&&!n.match(/\/$/)&&(n+="/"),n},_librarySelectedHandler:function(n,t,i){var u,r;this._closeLibrary();i&&(u=i.entities,u.length>0&&(r=i.context,r=="\\"&&(r=""),r=r.replace(this._subFolder+"\\","").replace(/\\/g,"/"),jQuery(this._fileFieldElement).val(r+u[0].Name).trigger("change")))},_libraryClosedHandler:function(){this._closeLibrary()},_onPreviewButtonClickHandler:null,_onDownloadButtonClickHandler:null,_onLibraryButtonClickHandler:null,initialize:function(){var r=jQuery("#"+this._fileFieldElementId),t,i;r.data("file_field",this);var n=jQuery("#"+this._fileWrapperElementId),f=n.find("."+this.BROWSE_BUTTON_CLASS_NAME+":first"),u=n.find("."+this.PREVIEW_BUTTON_CLASS_NAME+":first");u.bind("click",this._onPreviewButtonClickHandler);t=n.find("."+this.LIBRARY_BUTTON_CLASS_NAME+":first");t.bind("click",this._onLibraryButtonClickHandler);i=n.find("."+this.DOWNLOAD_BUTTON_CLASS_NAME+":first");i.bind("click",this._onDownloadButtonClickHandler);this._fileFieldElement=r.get(0);this._fileWrapperElement=n.get(0);this._browseButtonElement=f.get(0);this._previewButtonElement=u.get(0);this._libraryButtonElement=t.get(0);this._downloadButtonElement=i.get(0);this._allowFileUpload&&this._initFileUploader();r=null;n=null;f=null;u=null;t=null;i=null},_initFileUploader:function(){var n=this._isImage?LIBRARY_FILE_EXTENSIONS_DICTIONARY[Quantumart.QP8.Enums.LibraryFileType.Image]:"";this._uploaderType==Quantumart.QP8.Enums.UploaderType.Silverlight?this._uploaderComponent=new Quantumart.QP8.BackendSilverlightUploader(this._fileWrapperElement,{background:"#ffffff",extensions:n,resolveName:this.get_renameMatched()}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.Html?this._uploaderComponent=new Quantumart.QP8.BackendHtmlUploader(this._fileWrapperElement,{extensions:n,resolveName:this.get_renameMatched()}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.PlUpload&&(this._uploaderComponent=new Quantumart.QP8.BackendPlUploader($(this._fileWrapperElement),{extensions:n,resolveName:this.get_renameMatched(),useSiteLibrary:this._useSiteLibrary,getFormScriptOptions:this._getFormScriptOptions.bind(this)}));this._uploaderComponent.initialize();this.updateUploader();this._uploaderComponent.attachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED,jQuery.proxy(this._onFileUploadedHandler,this))},_getFormScriptOptions:function(){return{imgFilterResolution:this.imgFilterResolution}},_previewImage:function(){var n=jQuery(this._fileFieldElement),i,t,r,u;$q.isNullOrEmpty(n)||(i=n.attr("name"),t=n.val(),$q.isNullOrWhiteSpace(t)||($c.destroyPopupWindow(this._previewWindowComponent),r={id:i,fileName:encodeURIComponent(t),isVersion:this._isVersion,entityId:this._entityId,parentEntityId:this._libraryParentEntityId},u=Quantumart.QP8.BackendLibrary.generateActionUrl("GetImageProperties",r),this._previewWindowComponent=$c.preview(u)))},_downloadFieldFile:function(){var t=jQuery(this._fileFieldElement),i,n,r,u;$q.isNullOrEmpty(t)||(i=t.attr("name"),n=t.val(),$q.isNullOrWhiteSpace(n)||(r={id:i,fileName:encodeURIComponent(n),isVersion:this._isVersion,entityId:this._entityId},u=Quantumart.QP8.BackendLibrary.generateActionUrl("TestFieldValueDownload",r),$c.downloadFileWithChecking(u,n)))},getUrl:function(){return this._libraryUrl+jQuery(this._fileFieldElement).val()},pasteUrl:function(n){jQuery(this._fileFieldElement).val(n.replace(this._libraryUrl,""))},_openLibrary:function(){var i=this._isImage?Quantumart.QP8.Enums.LibraryFileType.Image:"",n=new Quantumart.QP8.BackendEventArgs,t;n.set_entityId(this._libraryEntityId);n.set_parentEntityId(this._libraryParentEntityId);n.set_entityName("");n.set_entityTypeCode(this._useSiteLibrary?ENTITY_TYPE_CODE_SITE:ENTITY_TYPE_CODE_CONTENT);n.set_actionCode(this._useSiteLibrary?ACTION_CODE_POPUP_SITE_LIBRARY:ACTION_CODE_POPUP_CONTENT_LIBRARY);t={isMultiOpen:!0,additionalUrlParameters:{filterFileTypeId:i,subFolder:this._subFolder,allowUpload:this._allowFileUpload}};this._selectPopupWindowComponent||(this._selectPopupWindowComponent=new Quantumart.QP8.BackendSelectPopupWindow(n,t),this._selectPopupWindowComponent.attachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_RESULT_SELECTED,jQuery.proxy(this._librarySelectedHandler,this)),this._selectPopupWindowComponent.attachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_CLOSED,jQuery.proxy(this._libraryClosedHandler,this)));this._selectPopupWindowComponent.openWindow();n=null;t=null},_closeLibrary:function(){this._selectPopupWindowComponent.closeWindow()},_destroyLibrary:function(){this._selectPopupWindowComponent&&(this._selectPopupWindowComponent.detachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_RESULT_SELECTED),this._selectPopupWindowComponent.detachObserver(EVENT_TYPE_SELECT_POPUP_WINDOW_CLOSED),this._selectPopupWindowComponent.dispose(),this._selectPopupWindowComponent=null)},_onFileUploadedHandler:function(n,t,i){i.get_fileNames().length>0&&jQuery(this._fileFieldElement).val(this._getFileFieldSubFolder()+i.get_fileNames()[0]).trigger("change")},_onPreviewButtonClick:function(){this._previewImage()},_onDownloadButtonClick:function(){this._downloadFieldFile()},_onLibraryButtonClick:function(){this._openLibrary()},dispose:function(){var n,t,i,r;this._destroyLibrary();n=jQuery(this._fileFieldElement);n.removeData();n=null;this._downloadButtonElement&&(t=jQuery(this._downloadButtonElement),t.unbind("click",this._onDownloadButtonClickHandler),t=null,this._downloadButtonElement=null);this._previewWindowComponent&&($c.destroyPopupWindow(this._previewWindowComponent),this._previewWindowComponent=null);this._previewButtonElement&&(i=jQuery(this._previewButtonElement),i.unbind("click",this._onPreviewButtonClickHandler),i=null,this._previewButtonElement=null);this._libraryButtonElement&&(r=jQuery(this._libraryButtonElement),r.unbind("click",this._onLibraryButtonClickHandler),r=null,this._libraryButtonElement=null);this._uploaderComponent&&(this._uploaderComponent.detachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED),this._uploaderComponent.dispose(),this._uploaderComponent=null);this._browseButtonElement=null;this._fileWrapperElement=null;this._fileFieldElement=null;this._onPreviewButtonClickHandler=null;this._onDownloadButtonClickHandler=null;this._onLibraryButtonClickHandler=null}};Quantumart.QP8.BackendFileField.registerClass("Quantumart.QP8.BackendFileField",null,Sys.IDisposable);