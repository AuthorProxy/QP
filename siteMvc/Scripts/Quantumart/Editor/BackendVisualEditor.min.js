Quantumart.QP8.BackendVisualEditor=function(n){var t=jQuery(n);this._$containerElem=jQuery(".visualEditorContainer",t);this._componentElem=t.get(0);this._editorElem=jQuery(".visualEditor",t).get(0)};Quantumart.QP8.BackendVisualEditor.DATA_KEY_COMPONENT="ve_data_key";Quantumart.QP8.BackendVisualEditor.getComponent=function(n){if(n){var t=jQuery(n);return t.data(Quantumart.QP8.BackendVisualEditor.DATA_KEY_COMPONENT)}};Quantumart.QP8.BackendVisualEditor.prototype={_componentElem:null,_editorElem:null,_$containerElem:null,_onChangeVisualEditorDataInDesignModeHandlerProxy:null,_isInitialized:!1,_$expandLink:null,_$collapseLink:null,_$textEditorLink:null,_$visualEditorLink:null,_siteId:null,_fieldId:null,_isExpanded:null,_isTextEditor:null,_storedTempValue:"",_checkIntervalID:null,initialize:function(){jQuery(this._componentElem).data(Quantumart.QP8.BackendVisualEditor.DATA_KEY_COMPONENT,this);this._onChangeVisualEditorDataInDesignModeHandlerProxy=jQuery.proxy(this._onChangeVisualEditorDataInDesignModeHandler,this);this._$expandLink=jQuery(".visualEditorToolbar LI.expand",this._componentElem);this._$collapseLink=jQuery(".visualEditorToolbar LI.collapse",this._componentElem);this._$textEditorLink=jQuery(".visualEditorToolbar LI.texteditor",this._componentElem);this._$visualEditorLink=jQuery(".visualEditorToolbar LI.visualeditor",this._componentElem);this._fieldId=jQuery(this._editorElem).data("field_id");this._siteId=jQuery(this._editorElem).data("library_entity_id");this._isExpanded=$q.toBoolean(jQuery(this._editorElem).data("is_expanded"));this._isTextEditor=$q.toBoolean(jQuery(this._editorElem).data("is_texteditor"));var n=this;(this._isTextEditor?this._$visualEditorLink:this._$expandLink).click(function(t){n._isInitialized||(n._isInitialized=!0,setTimeout(function(){CKEDITOR.replace(n._editorElem.id,{customConfig:"/Backend/VisualEditorConfig/LoadVeConfig?fieldId="+n._fieldId+"&siteId="+n._siteId+"&_="+(new Date).getTime(),on:{instanceReady:function(t){var i,r,u;if(this.setReadOnly($q.toBoolean(jQuery(t.editor.element.$).data("is_readonly"),!1)),i=this.document,i){i.on("keyup",n._onChangeVisualEditorDataInDesignModeHandler,n);i.on("paste",n._onChangeVisualEditorDataInDesignModeHandler,n);i=null}r=CKEDITOR.dtd;for(u in CKEDITOR.tools.extend({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.dataProcessor.writer.setRules(u,{indent:!1,breakAfterOpen:!1});this.dataProcessor.writer.setRules("br",{breakAfterOpen:!1});n._onCKEEditorInitialized(this)},afterCommandExec:n._onChangeVisualEditorDataInDesignModeHandlerProxy,loadSnapshot:n._onChangeVisualEditorDataInDesignModeHandlerProxy,configLoaded:function(t){var i=jQuery(t.editor.element.$);jQuery.extend(t.editor.config,{baseFloatZIndex:n.getZIndex()});i=null}}})},0));t.preventDefault()});this._isTextEditor?(this._$textEditorLink.click(function(t){n.disposeCKEditor(!1);n._$containerElem.show();n._$visualEditorLink.show();n._$textEditorLink.hide();n._$collapseLink.hide();n._$expandLink.hide();n._isInitialized=!1;t.preventDefault()}),this._$containerElem.show()):this._isExpanded&&this._$expandLink.trigger("click")},getCKEditor:function(){var n=jQuery(this._editorElem).attr("id");return CKEDITOR.instances[n]},saveVisualEditorData:function(){var n=this.getCKEditor();n&&(n.updateElement(),n=null)},getZIndex:function(){var n=jQuery(this._componentElem).closest(".t-window"),t=n.length>0?parseInt(n.css("zIndex"),10):0;return t+1e4},dispose:function(){this.disposeCKEditor(!1);this._onChangeVisualEditorDataInDesignModeHandlerProxy=null;this._editorElem=null;this._componentElem=null;this._$expandLink.off();this._$expandLink=null;this._$collapseLink.off();this._$collapseLink=null;this._$textEditorLink.off();this._$textEditorLink=null;this._$visualEditorLink.off();this._$visualEditorLink=null;this._$containerElem=null;this._siteId=null;this._fieldId=null},disposeCKEditor:function(n){var i,t,r,u;this._checkIntervalID&&clearInterval(this._checkIntervalID);i=jQuery(this._editorElem);this._destroyVisualEditorWindow(i,"imageWindow");this._destroyVisualEditorWindow(i,"linkWindow");this._destroyVisualEditorWindow(i,"flashWindow");t=this.getCKEditor();t&&(r=t.textarea,r&&(r.removeAllListeners(),r=null),u=t.document,u&&(u.removeAllListeners(),u=null),t.removeListener("afterCommandExec",this._onChangeVisualEditorDataInDesignModeHandlerProxy),t.removeListener("loadSnapshot",this._onChangeVisualEditorDataInDesignModeHandlerProxy),t.destroy(n),t=null);i.removeData();i=null},_onChangeVisualEditorDataInDesignModeHandler:function(){var t=this.getCKEditor(),n;if(t){if(n=t.textarea,n){if(!n.hasListeners("keyup"))n.on("keyup",this._onChangeVisualEditorDataInSourceModeHandler,this);if(!n.hasListeners("paste"))n.on("paste",this._onChangeVisualEditorDataInSourceModeHandler,this);n=null}jQuery("#"+t.name).addClass(CHANGED_FIELD_CLASS_NAME);t=null}},_onChangeVisualEditorDataInSourceModeHandler:function(){var n=this.getCKEditor();n&&(jQuery("#"+n.name).addClass(CHANGED_FIELD_CLASS_NAME),n=null)},_onCheckChangesIntervalHandler:function(){var n=this.getCKEditor(),t;n&&this._storedTempValue!==n.getData()&&(this._storedTempValue=n.getData(),n.element&&n.element.$&&(t=jQuery(n.element.$),t.addClass(CHANGED_FIELD_CLASS_NAME),t.trigger(JQ_CUSTOM_EVENT_ON_FIELD_CHANGED,{fieldName:t.attr("name"),value:n.getData()}),t=null));n=null},_destroyVisualEditorWindow:function(n,t){n.data(t)&&n.data(t).dispose()},_onCKEEditorInitialized:function(n){var t=this;n&&(this._storedTempValue=n.getData());this._checkIntervalID=setInterval(jQuery.proxy(this._onCheckChangesIntervalHandler,this),1e4);this._$containerElem.show();this._$expandLink.off("click").click(function(n){jQuery(this).hide();t._$collapseLink.show();t._$containerElem.show();n.preventDefault()}).hide();this._$collapseLink.click(function(n){jQuery(this).hide();t._$expandLink.show();t._$containerElem.hide();n.preventDefault()}).show();this._isTextEditor&&(t._$visualEditorLink.hide(),t._$textEditorLink.show(),t._$collapseLink.show(),t._$expandLink.hide())}};Quantumart.QP8.BackendVisualEditor.registerClass("Quantumart.QP8.BackendVisualEditor",null,Sys.IDisposable);