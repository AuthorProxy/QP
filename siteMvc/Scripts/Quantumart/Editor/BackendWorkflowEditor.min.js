Quantumart.QP8.BackendWorkflow=function(n){this._componentElem=n;this._containerElem=jQuery(".workflowContainer",n);this._checkSinglePermisssionHandler=jQuery.proxy(this.checkSinglePermission,this);this._checkAllPermisssionsHandler=jQuery.proxy(this.checkAllPermisssions,this)};Quantumart.QP8.BackendWorkflow.prototype={_componentElem:null,_resultElem:null,_containerElem:null,_addItemHandler:null,_removeItemHandler:null,_tableHeader:null,_tableBody:null,_items:null,_contentSelector:null,_checkSinglePermisssionHandler:null,_checkAllPermisssionsHandler:null,initialize:function(){function r(){jQuery(this).val()=="User"?(jQuery(this).closest("fieldset").find(".workflow_group_row").hide(),jQuery(this).closest("fieldset").find(".workflow_user_row").show()):(jQuery(this).closest("fieldset").find(".workflow_user_row").hide(),jQuery(this).closest("fieldset").find(".workflow_group_row").show())}var n=this._componentElem,u=this._contentSelector,t,i;this._items=ko.observableArray(jQuery.map(n.data("workflow_list_data"),function(n){var t={};return jQuery.extend(t,n,{RadioChecked:ko.observable(n.RadioChecked),Description:ko.observable(n.Description),UserId:ko.observable(n.UserId),GroupId:ko.observable(n.GroupId)}),t}));this._contentSelector=this._componentElem.closest("form").find(".workflow_content_selector");t={items:this._items,contentSelector:this._contentSelector,checkSinglePermisssionHandler:this._checkSinglePermisssionHandler,initializePickers:function(n,t){Quantumart.QP8.ControlHelpers.initAllEntityDataLists(jQuery(n));jQuery(n).find(".pep-user-selector").first().data("entity_data_list_component").selectEntities([t.UserId()]);jQuery(n).find(".pep-user-selector").last().data("entity_data_list_component").selectEntities([t.GroupId()]);$(n).find("."+CHANGED_FIELD_CLASS_NAME).removeClass(CHANGED_FIELD_CLASS_NAME);var i=this.contentSelector.find("input:checkbox:checked").map(function(n,t){return $(t).val()}).get().join();t.UserId()!=null||t.GroupId()!=null?$q.getJsonFromUrl("GET",CONTROLLER_URL_WORKFLOW+"CheckUserOrGroupAccessOnContents",{contentIdsString:i,statusName:t.StName,userIdString:t.UserId,groupIdString:t.GroupId},!1,!1,function(i){t.UserId()!=null?jQuery(n).find("span.workflow_permission_message").first().html(i):jQuery(n).find("span.workflow_permission_message").last().html(i)}):jQuery(n).find(".singleItemPicker").each(jQuery.proxy(function(n,t){jQuery(t).data("entity_data_list_component").attachObserver(EVENT_TYPE_ENTITY_LIST_SELECTION_CHANGED,this.checkSinglePermisssionHandler)},this))},disposePickers:function(n){Quantumart.QP8.ControlHelpers.destroyAllEntityDataLists(jQuery(n));jQuery(n).remove()}};ko.applyBindingsToNode(this._containerElem.get(0),{template:{name:n.attr("id").replace("_workflow_control","_template")}},t);this._resultElem=jQuery(".workflowResult",this._componentElem);i=this;this._componentElem.closest("form").find(".workflow_control_selector").parent("div").find(".checkbox").change(function(n){i.manageItems(n)});this._contentSelector.data("entity_data_list_component").attachObserver(EVENT_TYPE_ENTITY_LIST_SELECTION_CHANGED,this._checkAllPermisssionsHandler);this._containerElem.find(".singleItemPicker").each(jQuery.proxy(function(n,t){jQuery(t).data("entity_data_list_component").attachObserver(EVENT_TYPE_ENTITY_LIST_SELECTION_CHANGED,this._checkSinglePermisssionHandler)},this));jQuery(".workflow_radio").live("click",r);this._componentElem.data("workflow",this)},getCheckedContentsIds:function(){return this._contentSelector.find("input:checkbox:checked").map(function(n,t){return $(t).val()}).get().join()},checkAllPermisssions:function(){var n=this.getCheckedContentsIds(),t=jQuery.map(this._items(),function(n){return{StName:n.StName,UserId:n.UserId(),GroupId:n.GroupId()}});$q.getJsonFromUrl("GET",CONTROLLER_URL_WORKFLOW+"CheckAllAccessOnContents",{contentIdsString:n,modelString:JSON.stringify(t)},!1,!1,jQuery.proxy(function(n){var i,t,r;this._containerElem.find("span.workflow_permission_message").html("");for(i in n){var f=this._containerElem.find("."+n[i].StName),e=f.find(":visible.workflow_user_row"),u=f.find(":visible.workflow_group_row");e.size()>u.size()?(t=e.find("span.workflow_permission_message"),r=t.html(),t.html(r+"<br>"+n[i].Message)):(t=u.find("span.workflow_permission_message"),r=t.html(),u.find("span.workflow_permission_message").html(r+"<br>"+n[i].Message))}},this))},checkSinglePermission:function(n,t){var u=this.getCheckedContentsIds(),f=$(t._listElement).closest("fieldset").attr("Class").replace("workflow_fieldset",""),i,r;t.get_entityTypeCode()=="user"?i=t.getSelectedEntities()[0]!=null?t.getSelectedEntities()[0].Id:null:t.get_entityTypeCode()=="user_group"&&(r=t.getSelectedEntities()[0]!=null?t.getSelectedEntities()[0].Id:null);$q.getJsonFromUrl("GET",CONTROLLER_URL_WORKFLOW+"CheckUserOrGroupAccessOnContents",{contentIdsString:u,statusName:f,userIdString:i,groupIdString:r},!1,!1,function(n){var i=$(t._listElement).closest("fieldset"),r=i.find(":visible.workflow_user_row"),u=i.find(":visible.workflow_group_row");r.size()>u.size()?r.find("span.workflow_permission_message").html(n):u.find("span.workflow_permission_message").html(n)})},manageItems:function(n){var t=jQuery(n.target);t.size()==0&&(t=jQuery(n));t.parent("div").hasClass("groupCheckbox")?t.parent(".groupCheckbox").siblings(".workflow_control_selector").find(".checkbox").each(jQuery.proxy(function(n,t){this.manageItems(jQuery(t))},this)):t.attr("checked")=="checked"?this.addItem(t.val(),t.siblings("label").text(),t.closest(".workflow_control_selector").data("weights")[t.val()]):this.removeItem(t.val())},addItem:function(n,t,i){var u=ko.utils.arrayFirst(this._items(),function(t){return t.StId==n}),r;u==null&&(r={StName:t,StId:n,RadioChecked:ko.observable("User"),UserId:ko.observable(null),GroupId:ko.observable(null),Description:ko.observable("(no comments)"),Weight:i,Invalid:!1},this._items.push(r),this._items.sort(function(n,t){return n.Weight==t.Weight?0:n.Weight>t.Weight?1:-1}),this._setAsChanged())},removeItem:function(n){for(var i,r=this._items(),t=0;t<r.length;t++)i=r[t],i.StId==n&&this._items.remove(i);this._setAsChanged()},_setAsChanged:function(){var n=jQuery(this._resultElem);n.addClass(CHANGED_FIELD_CLASS_NAME);n.trigger(JQ_CUSTOM_EVENT_ON_FIELD_CHANGED,{fieldName:n.attr("name"),value:this._items()});n=null},destroyWorkflow:function(){var n=this._containerElem;n.find(".singleItemPicker").each(jQuery.proxy(function(n,t){jQuery(t).data("entity_data_list_component").detachObserver(EVENT_TYPE_ENTITY_LIST_SELECTION_CHANGED,this._checkSinglePermisssionHandler)}),this);this._contentSelector.data("entity_data_list_component").detachObserver(EVENT_TYPE_ENTITY_LIST_SELECTION_CHANGED,this._checkAllPermisssionsHandler);ko.cleanNode(n.get(0));this._componentElem=null;this._containerElem=null;this._resultElem=null}};