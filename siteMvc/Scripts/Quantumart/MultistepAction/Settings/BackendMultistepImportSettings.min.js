Quantumart.QP8.MultistepActionImportSettings=function(n){this.options=n};Quantumart.QP8.MultistepActionImportSettings.prototype={IMPORT_BUTTON:"Import",_fileWrapperElement:null,_fileWrapperElementId:"",fileName:"",_$importAction:null,_$uniqueFieldToUpdate:null,_$uniqueContentFieldId:null,_$fieldGroup:null,_$fields:null,_$identifiers:null,_fieldsPredicate:null,_uniqueFieldToUpdatePredicate:null,_identifiersPredicate:null,_renameMatch:!0,_useSiteLibrary:!1,_uploaderType:Quantumart.QP8.Enums.UploaderType.PlUpload,_onFileUploadedHandler:"",_fileNameId:"FileName",_noHeadersId:"NoHeaders",options:null,_initFileUploader:function(n,t){this._fileWrapperElementId=n._popupWindowId+"_upload_pl_cont_import";var i=jQuery("#"+this._fileWrapperElementId);this._fileWrapperElement=i.get(0);jQuery(this._fileWrapperElement).closest(".documentWrapper").addClass("ImportWrapper");this._uploaderType==Quantumart.QP8.Enums.UploaderType.Silverlight?this._uploaderComponent=new Quantumart.QP8.BackendSilverlightUploader(this._fileWrapperElement,{background:"#ffffff",extensions:"",resolveName:this._renameMatch}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.Html?this._uploaderComponent=new Quantumart.QP8.BackendHtmlUploader(this._fileWrapperElement,{extensions:"",resolveName:this._renameMatch}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.PlUpload&&(this._uploaderComponent=new Quantumart.QP8.BackendPlUploader(this._fileWrapperElement,{extensions:"",resolveName:this._renameMatch,useSiteLibrary:this._useSiteLibrary}));this._uploaderComponent.initialize();this._uploaderComponent.set_folderPath(t);this._uploaderComponent.attachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED,jQuery.proxy(this._onFileUploadedHandler,this))},_onFileUploadedHandler:function(n,t,i){this.fileName=i.get_fileNames()[0];$("#"+this.options._popupWindowId+"_"+this._fileNameId).val(this.fileName);$("#"+this._fileNameId).val(this.fileName);$("#"+this.options._popupWindowId+"_"+this._noHeadersId).prop("disabled",!0);this._loadFileFields(this.options)},_initValidation:function(){var n=this,t=this.options._popupWindowId;this._$importAction=$("#"+t+"_ImportAction");this._$uniqueFieldToUpdate=$("#"+t+"_UniqueFieldToUpdate");this._$uniqueContentFieldId=$("#"+t+"_UniqueContentFieldId");this._$fieldGroup=$("#"+this.options._popupWindowId+"_mapping_fields_selects");this._$fields=$("select[data-required='True']");this._$identifiers=$("select[data-identifier='True']");this._uniqueFieldToUpdatePredicate=function(){return+n._$importAction.val()>0};this._fieldsPredicate=function(t){var r=!0,i;return t&&(i=t.parent().children().first().filter("select[data-identifier='True']"),i.length==1&&(r=i.val()!="-1")),r&&$.inArray(+n._$importAction.val(),[0,1,2])>-1};this._identifiersPredicate=function(n){return n.parent().find('[data-identifier="False"]select[value!="-1"]').length>0};this._$uniqueFieldToUpdate.on("change",this._validateSelect(this._uniqueFieldToUpdatePredicate));this._$fieldGroup.on("change","select[data-identifier='True']",function(){n._validateSelect(n._identifiersPredicate).call(this);var t=$(this).parent().find("select[data-required='True']");n._showValidationSigns(t,n._fieldsPredicate);t.each(function(){n._validateSelect(n._fieldsPredicate).call(this)})}).on("change","select[data-required='True']",this._validateSelect(this._fieldsPredicate)).on("change","select[data-required]",function(){var t=n._$identifiers;n._showValidationSigns(t,n._identifiersPredicate);t.each(function(){n._validateSelect(n._identifiersPredicate).call(this)})});if(this._$uniqueContentFieldId.length==1){this._$uniqueContentFieldId.on("change",function(){n._updateMappingOptions.call(n)});this._$uniqueFieldToUpdate.on("change",function(){n._updateMappingOptions.call(n)})}this._$importAction.on("change",function(){n._showValidationSigns(n._$fields,n._fieldsPredicate);n._$fields.trigger("change");n._$uniqueFieldToUpdate.trigger("change");n._showValidationSigns($(".star:first"),n._uniqueFieldToUpdatePredicate)})},_updateMappingOptions:function(){var i=this,t,n;this._$uniqueContentFieldId.removeClass("input-validation-error");$(".mapped").removeClass("mapped");$("option:hidden").show();this._$uniqueFieldToUpdate.val()!="-1"&&this._$uniqueContentFieldId.val()!=""&&($(this._$uniqueFieldToUpdate).addClass("mapped"),$(this._$uniqueContentFieldId).addClass("mapped"),t=$("span.relatedFieldsArray").filter(function(){return $(this).text()===i._$uniqueContentFieldId.find("option:selected").text()}),t.addClass("mapped"),n=t.prev().prev(),n.addClass("mapped"),n.find("option[value!='-1']option[value!='"+this._$uniqueFieldToUpdate.val()+"']").hide(),n.attr("data-broken-integrity")=="True"&&$(this._$uniqueContentFieldId).addClass("input-validation-error"),this._$uniqueFieldToUpdate.val()!=n.val()&&n.val("-1"))},_validate:function(){this._$importAction.trigger("change")},_disposeValidation:function(){this._$fieldGroup&&(this._$fieldGroup.off("change"),this._$fieldGroup=null);this._$identifiers&&(this._$identifiers.off("change"),this._$identifiers=null);this._$importAction&&(this._$importAction.off("change"),this._$importAction=null);this._$uniqueFieldToUpdate&&(this._$uniqueFieldToUpdate.off("change"),this._$uniqueFieldToUpdate=null);this._$uniqueContentFieldId&&(this._$uniqueContentFieldId.off("change"),this._$uniqueContentFieldId=null);this._$fields=null},_validateSelect:function(n){return function(){n($(this))&&+$(this).val()==-1?$(this).addClass("input-validation-error"):$(this).removeClass("input-validation-error")}},_showValidationSigns:function(n,t){n.each(function(){var n=$(this);n.hasClass("star")||(n=n.nextAll().filter(".star:first"));t($(this))?n.show():n.hide()})},_addMessageLine:function(n){return n.length>0?n+"\n":n},AddButtons:function(n){var t={Type:TOOLBAR_ITEM_TYPE_BUTTON,Value:this.IMPORT_BUTTON,Text:$l.MultistepAction.importTitle,Tooltip:$l.MultistepAction.importTitle,AlwaysEnabled:!1,Icon:"action.gif"};return Array.add(n,t),n},InitActions:function(n,t){this._initFileUploader(n,t.UploadPath);this._initValidation()},Validate:function(){var t=this,n="",i;return this.fileName==""&&(n=$l.MultistepAction.NoDownloadedFile),this._uniqueFieldToUpdatePredicate()>0&&+this._$uniqueFieldToUpdate.val()==-1&&(n=$l.MultistepAction.UniqueFieldToUpdate),i=$("span.relatedFieldsArray").filter(function(){return $(this).text()===t._$uniqueContentFieldId.find("option:selected").text()}),i.prev().prev().attr("data-broken-integrity")=="True"&&(n=t._addMessageLine(n),n=$l.MultistepAction.BrokenDataIntegrity+i.text()),$('select[data-identifier="True"]select[value="-1"]').each(function(){$(this).parent().find("select[data-required='True']").each(function(){if(t._identifiersPredicate($(this))){var i=$(this).parents("fieldset:first").find("legend").text();n=t._addMessageLine(n)+($l.MultistepAction.UniqueExtensionFieldToUpdate+" "+i)}})}),this._$fields.each(function(){t._fieldsPredicate($(this))&&+$(this).val()==-1&&(n=t._addMessageLine(n)+($(this).nextAll(".relatedFieldsArray").html()+$l.MultistepAction.RequiredField))}),$('select[data-aggregated="False"]select[data-required="True"]').length!=0&&this._fieldsPredicate(null)||$('select[data-aggregated="False"]select[value!="-1"]').length!=0||(n=t._addMessageLine(n)+$l.MultistepAction.AnyFieldRequired),n},_loadFileFields:function(n){var i="#"+n._popupWindowComponent._documentWrapperElementId+" ",r=$(i+'input[name="Delimiter"]:radio:checked').val(),t=this;$(i+'input[name="Delimiter"]').on("click",function(){t.loadFromFile(n,this.value)});$("#"+n._popupWindowId+"_Encoding, #"+n._popupWindowId+"_LineSeparator").on("change",function(){t.loadFromFile(n)});isNaN(r)||t.loadFromFile(n)},loadFromFile:function(n){var t=this,r=$("#"+n._popupWindowComponent._documentWrapperElementId+" form input, #"+n._popupWindowComponent._documentWrapperElementId+" form select").serialize(),u=new Quantumart.QP8.BackendActionExecutor.getBackendActionByCode(n._actionCode),i=String.format("{0}FileFields/0/{1}/{2}/",u.ControllerActionUrl,n._parentEntityId,n._contentId);i=i.replace(/^~\//,APPLICATION_ROOT_URL);$.ajax({url:i,data:r,type:"POST",success:function(n){n.Type=="Error"?($("#"+t.options._popupWindowId+"_mapping_fields_selects").hide(),alert(n.Text)):n&&(t._fillOptionsFromFile(n),t._validate())}})},_fillOptionsFromFile:function(n){var t=" .dropDownList.dataList.fields",i="#"+this.options._popupWindowComponent._documentWrapperElementId+" ";$(i+t).html("");$.each($(i+t),function(t,i){$(i).append($("<option>",{value:-1,text:""}));$.each(n,function(n,t){$(i).append($("<option>",{value:t,text:t,selected:$(i).next().html()==t}))})});this._$uniqueFieldToUpdate.val("CONTENT_ITEM_ID");this._$fieldGroup.show()},dispose:function(){this._disposeValidation();this._uploaderComponent&&(this._uploaderComponent.detachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED),this._uploaderComponent.dispose(),this._uploaderComponent=null)}};