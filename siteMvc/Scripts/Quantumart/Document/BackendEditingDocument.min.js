Quantumart.QP8.BackendEditingDocument=function(n,t,i,r){if(!n)throw new Error($l.EditingArea.tabIdNotSpecifiedInConstructor);if(!t)throw new Error($l.EditingArea.editingAreaNotSpecifiedInConstructor);Quantumart.QP8.BackendEditingDocument.initializeBase(this,[i,r]);this._editingArea=t;this._tabId=n;this._id=this.getDocumentIdByTabId(this._tabId);$q.isObject(i)&&(this._applyEventArgs(i,!0),this.bindExternalCallerContext(i),this._selectedEntities=[],i.get_context()&&i.get_context().additionalUrlParameters&&(this._additionalUrlParameters=i.get_context().additionalUrlParameters))};Quantumart.QP8.BackendEditingDocument.prototype={_id:"",_tabId:"",_editingArea:null,_additionalUrlParameters:null,get_id:function(){return this._id},get_tabId:function(){return this._tabId},set_tabId:function(n){this._tabId=n},get_editingArea:function(){return this._editingArea},get_hostType:function(){return DOCUMENT_HOST_TYPE_EDITING_DOCUMENT},get_zIndex:function(){return 0},initialize:function(n){this.generateDocumentUrl();this.createPanels();this.renderPanels();this.addNewDocumentWrapper();this._loadDefaultSearchBlockState();this.loadHtmlContentToDocumentWrapper(n)},getDocumentIdByTabId:function(n){return this._editingArea.getDocumentIdByTabId(n)},generateDocumentWrapperId:function(){return String.format("doc_{0}",this._tabId)},addNewDocumentWrapper:function(){var n=this._documentWrapperElementId,t,i;return $q.isNullOrWhiteSpace(n)&&(n=this.generateDocumentWrapperId()),t=jQuery("#"+n),$q.isNullOrEmpty(t)&&(t=jQuery("<div />",{id:n,"class":"documentWrapper"}),i=jQuery(this._editingArea.get_documentsContainerElement()),i.append(t),i=null),this._documentWrapperElementId=n,this._documentWrapperElement=t.get(0),t=null,n},generateDocumentUrl:function(n){var r=this._isMultipleEntities?$o.getEntityIDsFromEntities(this._entities):[this._entityId],t={additionalUrlParameters:this._additionalUrlParameters,controllerActionUrl:this.getCurrentViewActionUrl()},u,i;this.get_isBindToExternal()===!0&&(t.additionalUrlParameters=jQuery.extend(t.additionalUrlParameters,{boundToExternal:!0}));n=$q.isObject(n)?jQuery.extend(n,t):t;u=$a.generateActionUrl(this._isMultipleEntities,r,this._parentEntityId,this._tabId,this.getCurrentAction(),n);this._documentUrl=u;i={};(this._isMultipleEntities||this._isCustomAction)&&(i.IDs=r);this._isCustomAction&&(i.actionCode=this._actionCode);this._documentPostParams=i},htmlLoadingMethod:function(){return this._isMultipleEntities||this._isCustomAction?"POST":"GET"},showErrorMessageInDocumentWrapper:function(){var n=jQuery(this._documentWrapperElement);n.html($q.generateErrorMessageText())},removeDocumentWrapper:function(n){var t=jQuery(this._documentWrapperElement);t.empty().remove();$q.callFunction(n)},createPanels:function(){var o=this.getCurrentAction(),u=Quantumart.QP8.BackendBreadCrumbsManager.getInstance().createBreadCrumbs("breadCrumbs_"+this._tabId,{documentHost:this,breadCrumbsContainerElementId:this._editingArea.get_breadCrumbsContainerElementId()}),f,t,i,e,r,n;u.attachObserver(EVENT_TYPE_BREAD_CRUMBS_ITEM_CLICK,this._onGeneralEventHandler);u.attachObserver(EVENT_TYPE_BREAD_CRUMBS_ITEM_CTRL_CLICK,this._onGeneralEventHandler);this._breadCrumbsComponent=u;f={toolbarContainerElementId:this._editingArea.get_actionToolbarContainerElementId()};t=this.get_eventArgsAdditionalData();t&&t.disabledActionCodes&&(f.disabledActionCodes=t.disabledActionCodes);i=new Quantumart.QP8.BackendActionToolbar("actionToolbar_"+this._tabId,this._actionCode,this._parentEntityId,f);i.initialize();i.attachObserver(EVENT_TYPE_ACTION_TOOLBAR_BUTTON_CLICKED,this._onGeneralEventHandler);this._actionToolbarComponent=i;e={toolbarContainerElementId:this._editingArea.get_viewToolbarContainerElementId()};r=this.loadHostState();r&&r.viewTypeCode&&(e.viewTypeCode=r.viewTypeCode);n=new Quantumart.QP8.BackendViewToolbar("viewToolbar_"+this._tabId,this._actionCode,e);n.initialize();n.attachObserver(EVENT_TYPE_VIEW_TOOLBAR_VIEWS_DROPDOWN_SELECTED_INDEX_CHANGED,this._onGeneralEventHandler);n.attachObserver(EVENT_TYPE_VIEW_TOOLBAR_SEARCH_BUTTON_CLICKED,this._onGeneralEventHandler);n.attachObserver(EVENT_TYPE_VIEW_TOOLBAR_CONTEXT_BUTTON_CLICKED,this._onGeneralEventHandler);this._viewToolbarComponent=n},showPanels:function(n){var r=jQuery(this._editingArea.get_breadCrumbsContainerElement()),t,i,u,f;r.find("> *.breadCrumbs:visible").hide(0);this._breadCrumbsComponent.showBreadCrumbs();r=null;t=jQuery(this._editingArea.get_actionToolbarContainerElement());t.find("> *.toolbar:visible").hide(0);this._actionToolbarComponent.showToolbar(n);t=null;i=jQuery(this._editingArea.get_viewToolbarContainerElement());i.find("> *.toolbar:visible").hide(0);this._viewToolbarComponent.showToolbar();i=null;this.fixActionToolbarWidth();this.get_isSearchBlockVisible()&&this._searchBlockComponent&&(u=jQuery(this._editingArea.get_searchBlockContainerElement()),u.find("> *.searchBlock:visible").hide(0),this._searchBlockComponent.showSearchBlock());this._isContextBlockVisible&&this._contextBlockComponent&&(f=jQuery(this._editingArea.get_contextBlockContainerElement()),f.find("> *.contextBlock:visible").hide(0),this._contextBlockComponent.showSearchBlock())},hidePanels:function(){this._breadCrumbsComponent.hideBreadCrumbs();this._actionToolbarComponent.hideToolbar();this._viewToolbarComponent.hideToolbar();this.get_isSearchBlockVisible()&&this._searchBlockComponent&&this._searchBlockComponent.hideSearchBlock();this._isContextBlockVisible&&this._contextBlockComponent&&this._contextBlockComponent.hideSearchBlock()},createSearchBlock:function(){var n=Quantumart.QP8.BackendSearchBlockManager.getInstance().createSearchBlock("searchBlock_"+this._tabId,this._entityTypeCode,this._parentEntityId,this,{searchBlockContainerElementId:this._editingArea.get_searchBlockContainerElementId(),tabId:this._tabId,actionCode:this._actionCode,searchBlockState:this.getHostStateProp("searchBlockState")});n.attachObserver(EVENT_TYPE_SEARCH_BLOCK_FIND_START,this._onSearchHandler);n.attachObserver(EVENT_TYPE_SEARCH_BLOCK_RESET_START,this._onSearchHandler);n.attachObserver(EVENT_TYPE_SEARCH_BLOCK_RESIZED,this._onSearchBlockResizeHandler);this._searchBlockComponent=n},createContextBlock:function(){var n=Quantumart.QP8.BackendSearchBlockManager.getInstance().createSearchBlock("contextBlock_"+this._tabId,this._entityTypeCode,this._parentEntityId,this,{searchBlockContainerElementId:this._editingArea.get_contextBlockContainerElementId(),tabId:this._tabId,actionCode:this._actionCode,contextSearch:!0,hideButtons:!0,searchBlockState:this.get_contextState()});n.initialize();n.attachObserver(EVENT_TYPE_CONTEXT_BLOCK_FIND_START,this._onContextSwitchingHandler);this._contextBlockComponent=n},destroySearchBlock:function(){var n=this._searchBlockComponent,t;n&&(n.hideSearchBlock(),n.detachObserver(EVENT_TYPE_SEARCH_BLOCK_FIND_START,this._onSearchHandler),n.detachObserver(EVENT_TYPE_SEARCH_BLOCK_RESET_START,this._onSearchHandler),n.detachObserver(EVENT_TYPE_SEARCH_BLOCK_RESIZED,this._onSearchBlockResizeHandler),t=n.get_searchBlockElementId(),Quantumart.QP8.BackendSearchBlockManager.getInstance().destroySearchBlock(t),this._searchBlockComponent=null)},destroyContextBlock:function(){var n=this._contextBlockComponent,t;n&&(n.hideSearchBlock(),n.detachObserver(EVENT_TYPE_CONTEXT_BLOCK_FIND_START,this._onContextSwitchingHandler),t=n.get_searchBlockElementId(),Quantumart.QP8.BackendSearchBlockManager.getInstance().destroySearchBlock(t),this._contextBlockComponent=null,this._isContextBlockVisible=!1)},showLoadingLayer:function(){this._editingArea&&this.isSelected()&&this._editingArea.showAjaxLoadingLayer()},hideLoadingLayer:function(){this._editingArea&&this.isSelected()&&this._editingArea.hideAjaxLoadingLayer()},destroyPanels:function(){var t,n;this._breadCrumbsComponent&&(this._breadCrumbsComponent.detachObserver(EVENT_TYPE_BREAD_CRUMBS_ITEM_CLICK,this._onGeneralEventHandler),this._breadCrumbsComponent.detachObserver(EVENT_TYPE_BREAD_CRUMBS_ITEM_CTRL_CLICK,this._onGeneralEventHandler),t=this._breadCrumbsComponent.get_breadCrumbsElementId(),Quantumart.QP8.BackendBreadCrumbsManager.getInstance().destroyBreadCrumbs(t),this._breadCrumbsComponent=null);this._actionToolbarComponent&&(this._actionToolbarComponent.detachObserver(EVENT_TYPE_ACTION_TOOLBAR_BUTTON_CLICKED,this._onGeneralEventHandler),this._actionToolbarComponent.dispose(),this._actionToolbarComponent=null);this._viewToolbarComponent&&(this._viewToolbarComponent.detachObserver(EVENT_TYPE_VIEW_TOOLBAR_VIEWS_DROPDOWN_SELECTED_INDEX_CHANGED,this._onGeneralEventHandler),this._viewToolbarComponent.detachObserver(EVENT_TYPE_VIEW_TOOLBAR_SEARCH_BUTTON_CLICKED,this._onGeneralEventHandler),this._viewToolbarComponent.detachObserver(EVENT_TYPE_VIEW_TOOLBAR_CONTEXT_BUTTON_CLICKED,this._onGeneralEventHandler),this._viewToolbarComponent.dispose(),this._viewToolbarComponent=null);n=this._editingArea;n&&($q.isNullOrWhiteSpace(this._id)||this._editingArea.removeDocument(this._id),n=null,this._editingArea=null)},isSelected:function(){return this._id==this._editingArea.getSelectedDocumentId()},updateTitle:function(n){this._editingArea.updateTab(this.get_tabId(),n)},onDocumentError:function(){this._isCloseForced=!1;this._editingArea.onDocumentError(this._id)},onChangeContent:function(n,t,i){var u=this._editingArea.getExistingTabId(i),r;if(u!=0){if(r=this._editingArea.selectDocument(u),r)r.onSelectedThroughExecution(i)}else this.changeContent(i)},saveSelectionContext:function(n){this._selectedParentEntityId=n.get_parentEntityId()},onActionExecuting:function(n){this._copyCurrentContextToEventArgs(n);return this._editingArea.onActionExecuting(n)},onEntityReaded:function(n){return this._editingArea.onEntityReaded(n)},onDocumentChanging:function(n){this._editingArea.onDocumentLoading(this._id,n)},onDocumentChanged:function(n){this._editingArea.onDocumentLoaded(this._id,n)},onNeedUp:function(){var n=0,i,t;if(this._callerContext&&this._callerContext.eventArgs&&(n=this._editingArea.getExistingTabId(this._callerContext.eventArgs),n!=0)){this._editingArea.selectDocument(n);this._editingArea.closeDocument(this.get_tabId(),!1,!0);return}n==0&&(i=this._breadCrumbsComponent.getLastItemButOne(),i&&(t=this._breadCrumbsComponent.getItemActionEventArgs(i),t&&(n=this._editingArea.getExistingTabId(t))),n!=0?(this._editingArea.selectDocument(n),this._editingArea.closeDocument(this.get_tabId(),!1,!0)):this.changeContent(t,!0))},saveAndCloseRequest:function(n){var t,i;Sys.Debug.trace("saveAndCloseRequest: "+n._tabId);t=this.get_documentContext();t&&t._options.saveAndCloseActionCode&&(i=this.get_mainComponent(),i!=null&&Quantumart.QP8.BackendEntityEditor.isInstanceOfType(i)&&i.isFieldsChanged()&&(this._isCloseForced=!0,this.executeAction(t._options.saveAndCloseActionCode)))},onSaveAndClose:function(){if(this._isCloseForced){this._isCloseForced=!1;var n=this.get_documentContext();n&&n.get_mainComponentType()==$e.MainComponentType.Editor&&!n.get_mainComponent()._formHasErrors&&this._editingArea.closeDocument(this.get_tabId(),!0)}},resetSelectedEntities:function(){$q.clearArray(this._selectedEntities)},_onLibraryResized:function(){var n=jQuery(this._editingArea.get_documentsContainerElement()),t=jQuery(this._documentWrapperElement);t.height(n.height());n=null;t=null},_onExternalCallerContextsUnbinded:function(n){this._editingArea.hostExternalCallerContextsUnbinded(n)},_isWindow:function(){return!1},dispose:function(){Quantumart.QP8.BackendEditingDocument.callBaseMethod(this,"dispose");this.destroyPanels();this.destroySearchBlock();this.destroyContextBlock();this.removeDocumentWrapper();$q.clearArray(this._entities);$q.clearArray(this._selectedEntities);this._documentContext=null;this._documentWrapperElement=null;$q.collectGarbageInIE()}};Quantumart.QP8.BackendEditingDocument.registerClass("Quantumart.QP8.BackendEditingDocument",Quantumart.QP8.BackendDocumentHost);