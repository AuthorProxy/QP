var EVENT_TYPE_TREE_MENU_ACTION_EXECUTING="OnTreeMenuActionExecuting",EVENT_TYPE_TREE_MENU_NODE_REMOVING="OnTreeMenuNodeRemoving",EVENT_TYPE_TREE_MENU_NODE_REMOVED="OnTreeMenuNodeRemoved";Quantumart.QP8.BackendTreeMenu=function(n,t){Quantumart.QP8.BackendTreeMenu.initializeBase(this,[n,t]);$q.isObject(t)&&(t.leftSplitterPaneHeight&&(this.leftSplitterPaneHeight=t.leftSplitterPaneHeight),t.contextMenuManager&&(this._contextMenuManagerComponent=t.contextMenuManager));this._onDataBindingHandler=jQuery.proxy(this._onDataBinding,this);this._onNodeClickingHandler=jQuery.proxy(this._onNodeClicking,this);this._onContextMenuHandler=jQuery.proxy(this._onContextMenu,this);this._onNodeContextMenuShowingHandler=jQuery.proxy(this._onNodeContextMenuShowing,this);this._onNodeContextMenuItemClickingHandler=jQuery.proxy(this._onNodeContextMenuItemClicking,this);this._onNodeContextMenuHiddenHandler=jQuery.proxy(this._onNodeContextMenuHidden,this)};Quantumart.QP8.BackendTreeMenu.prototype={_contextMenuManagerComponent:null,_leftSplitterPaneHeight:0,_contextMenuActionCode:"",NODE_BUSY_CLASS_NAME:"busy",get_contextMenuManager:function(){return this._contextMenuManager},set_contextMenuManager:function(n){this._contextMenuManager=n},_onDataBindingHandler:null,_onNodeClickingHandler:null,_onContextMenuHandler:null,_onNodeContextMenuShowingHandler:null,_onNodeContextMenuItemClickingHandler:null,_onNodeContextMenuHiddenHandler:null,initialize:function(){var t,n,i;Quantumart.QP8.BackendTreeMenu.callBaseMethod(this,"initialize");t=this._treeComponent;n=jQuery(this._treeComponent.element);this._contextMenuManagerComponent!=null&&(i=this._contextMenuManagerComponent.getContextMenuEventType(),n.delegate(this.NODE_NEW_CLICKABLE_SELECTORS,i,this._onContextMenuHandler));n=null;this._contextMenuManagerComponent!=null&&(this._contextMenuManagerComponent.attachObserver(EVENT_TYPE_CONTEXT_MENU_SHOWING,this._onNodeContextMenuShowingHandler),this._contextMenuManagerComponent.attachObserver(EVENT_TYPE_CONTEXT_MENU_ITEM_CLICKING,this._onNodeContextMenuItemClickingHandler),this._contextMenuManagerComponent.attachObserver(EVENT_TYPE_CONTEXT_MENU_HIDDEN,this._onNodeContextMenuHiddenHandler));this.addNodesToParentNode(t.element,2)},fixTreeHeight:function(n){$q.isNull(n)||(n=n-46,n>0&&(jQuery("#tree").css("height",n+"px"),jQuery("#menuContainer").show()))},markTreeAsBusy:function(){var n=jQuery(this._treeComponent.element);n.find("UL:first").addClass(this.NODE_BUSY_CLASS_NAME)},unmarkTreeAsBusy:function(){var n=jQuery(this._treeComponent.element);n.find("UL:first").removeClass(this.NODE_BUSY_CLASS_NAME)},isTreeBusy:function(){var n=jQuery(this._treeComponent.element);return n.find("UL:first").hasClass(this.NODE_BUSY_CLASS_NAME)},generateNodeCode:function(n,t,i,r){return String.format("{0}{1}_{2}_{3}",n,r?"s":"",t,i?i:0)},generateNodeCodeToHighlight:function(n){var t=n.get_actionTypeCode()==ACTION_TYPE_CODE_LIST,i=t?Quantumart.QP8.BackendEntityType.getEntityTypeByCode(n.get_entityTypeCode()).Id:n.get_entityId();return this.generateNodeCode(n.get_entityTypeCode(),i,n.get_parentEntityId(),t)},addNodesToParentNode:function(n,t){this._addNodesToParentNode(n,t,Quantumart.QP8.BackendTreeMenu.getTreeMenuChildNodesList,function(n){$q.processGenericAjaxError(n)})},_addNodesToParentNode:function(n,t,i,r){var u=this;$parentNode=this.getNode(n);var f=this.isRootNode($parentNode),e=0,o=null,a=null,s=null,h=!1,c=!1,l=null;f||(e=this.getNodeLevel($parentNode),o=$parentNode.data("entity_type_code"),a=$parentNode.data("entity_id"),s=$parentNode.data("is_folder")?$parentNode.data("parent_entity_id"):$parentNode.data("entity_id"),h=$parentNode.data("is_folder"),c=$parentNode.data("is_group"),l=$parentNode.data("group_item_code"));(e<t||t==0)&&($parentNode.data("loading_icon_timeout",setTimeout(function(){$parentNode.find("> DIV > .t-icon").addClass("t-loading")},100)),i({entityTypeCode:o,parentEntityId:s,isFolder:h,isGroup:c,groupItemCode:l},function(n){var e=n,r=u.getTreeViewItemCollectionFromTreeNodes(e);if(r.length==0){r=null;return}u._renderChildNodes($parentNode,r,f);$q.clearArray(r);u._hideAjaxLoadingIndicatorForNode($parentNode);u._extendNodeElements($parentNode,e);t!=0&&$parentNode.find("> UL > LI").each(function(n,r){u._addNodesToParentNode(r,t,i)});$q.clearArray(e)},r))},_refreshNodeInner:function(n,t,i){if(!$q.isNullOrEmpty(n)){var r=this,u=this.getParentNode(n),o=u?u.data("entity_type_code"):null,s=u?n.data("entity_id"):0,f=u?u.data("is_folder"):!1,h=u?f?u.data("parent_entity_id"):u.data("entity_id"):null,c=u?u.data("is_group"):!1,l=u?u.data("group_item_code"):"",e=this.isRootNode(n);this._showAjaxLoadingIndicatorForNode(n);Quantumart.QP8.BackendTreeMenu.getTreeMenuNode(o,s,h,f,c,l,t,function(t){var u=t,s,o,f;if(u){if(u.NodeCode=r.generateNodeCode(u.Code,u.Id,u.ParentId,u.IsFolder),s=r.getTreeViewItemFromTreeNode(u),r._renderNode(n,s,e),r._extendNodeElement(n,u),s=null,o=u.ChildNodes,f=r.getTreeViewItemCollectionFromTreeNodes(o),f.length==0){r._hideAjaxLoadingIndicatorForNode(n);f=null;return}r._renderChildNodes(n,f,e);$q.clearArray(f);r._hideAjaxLoadingIndicatorForNode(n);r._extendNodeElements(n,o);$q.clearArray(o)}r._deferredNodeCodeToHighlight&&r.highlightNode(r._deferredNodeCodeToHighlight);$q.callFunction(i)},function(n){$q.processGenericAjaxError(n);$q.callFunction(i)})}},highlightNode:function(n){var t=this.getNode(n);$q.isNullOrEmpty(t)||(this.unhighlightAllNodes(),t.find(this.NODE_WRAPPER_SELECTOR).addClass(this.NODE_SELECTED_CLASS_NAME),this.scrollToNode(t))},highlightNodeWithEventArgs:function(n){var u=this.generateNodeCodeToHighlight(n),i,r,t;this._deferredNodeCodeToHighlight=u;i=this.getNode(u);$q.isNullOrEmpty(i)?!n.isExpandRequested||this._expandToEntityNode(n.get_entityTypeCode(),n.get_parentEntityId(),n.get_entityId()):(r=i,!n.isExpandRequested||(t=this,Quantumart.QP8.BackendTreeMenu.getSubTreeToEntity(n.get_entityTypeCode(),n.get_parentEntityId(),n.get_entityId(),function(n){if(!!n){var i=function(n){return!n||$q.isNullOrEmpty(t.getNode(t.generateNodeCode(n.Code,n.Id,n.ParentId,n.IsFolder)))?null:(r=t.getNode(t.getNode(t.generateNodeCode(n.Code,n.Id,n.ParentId,n.IsFolder))),t._isNodeCollapsed(r)&&t._treeComponent.nodeToggle(null,r,!0),i(jQuery.grep(n.ChildNodes,function(n){return n.ChildNodes!=null})[0])||n)};i(n)}})),this.highlightNode(i))},_expandToEntityNode:function(n,t,i){var r=this;Quantumart.QP8.BackendTreeMenu.getSubTreeToEntity(n,t,i,function(n){if(!!n){var i=function(n,t){return!n||$q.isNullOrEmpty(r.getNode(r.generateNodeCode(n.Code,n.Id,n.ParentId,n.IsFolder)))?null:(!t||($node=r.getNode(r.getNode(r.generateNodeCode(n.Code,n.Id,n.ParentId,n.IsFolder))),r._isNodeCollapsed($node)&&r._treeComponent.nodeToggle(null,$node,!0)),i(jQuery.grep(n.ChildNodes,function(n){return n.ChildNodes!=null})[0],t)||n)},u=function(n,i){return!i||$q.isNullOrEmpty(i.ChildNodes)?[]:i.Code===n.entityTypeCode&&(i.IsFolder&&i.ParentId===n.parentEntityId||!i.IsFolder&&i.Id===n.parentEntityId)&&i.IsFolder===n.isFolder&&i.IsGroup===n.isGroup&&i.GroupItemCode===n.groupItemCode?(t=i,i.ChildNodes):u(n,jQuery.grep(i.ChildNodes||[],function(n){return n.ChildNodes!=null})[0])},t=i(n);!t||(nodeCode=r.generateNodeCode(t.Code,t.Id,t.ParentId,t.IsFolder),$node=r.getNode(nodeCode),r._addNodesToParentNode($node,100,function(n,i){i(u(n,t).slice(0))},function(){}),t=i(n,!0),nodeCode=r.generateNodeCode(t.Code,t.Id,t.ParentId,t.IsFolder),$node=r.getNode(nodeCode),r._deferredNodeCodeToHighlight=nodeCode,r.highlightNode($node))}})},unhighlightAllNodes:function(){this._deferredNodeCodeToHighlight="";var n=this.getAllNodes();n.find(this.NODE_WRAPPER_SELECTOR).removeClass(this.NODE_SELECTED_CLASS_NAME);n=null},scrollToNode:function(n){var t=this.getNode(n);$q.isNullOrEmpty(t)||jQuery("#"+this._treeContainerElementId).scrollTo(t,{offset:-100,duration:300,axis:"y"});t=null},fillTreeViewItemFromTreeNode:function(n,t){var i=t.Icon.left(7).toLowerCase()!=="http://"?THEME_IMAGE_FOLDER_URL_SMALL_ICONS+t.Icon:t.Icon;return n.Value=t.NodeCode,n.Text=t.Title,n.ImageUrl=i,n.LoadOnDemand=t.HasChildren,n.Expanded=!1,n},getTreeViewItemFromTreeNode:function(n){var t={};return this.fillTreeViewItemFromTreeNode(t,n),t},fillTreeViewItemCollectionFromTreeNodes:function(n,t){var i=this,r=0;t!=null&&(r=t.length);r>0&&jQuery.each(t,function(t,r){r.NodeCode=i.generateNodeCode(r.Code,r.Id,r.ParentId,r.IsFolder);var u=i.getTreeViewItemFromTreeNode(r);Array.add(n,u)})},getTreeViewItemCollectionFromTreeNodes:function(n){var t=[];return this.fillTreeViewItemCollectionFromTreeNodes(t,n),t},_extendNodeElement:function(n,t){var i=this.getNode(n),r,u,f;i.data("entity_type_code",t.Code);i.data("entity_id",t.Id);i.data("entity_name",t.Title);i.data("parent_entity_id",t.ParentId);i.data("is_folder",t.IsFolder);i.data("is_group",t.IsGroup);i.data("group_item_code",t.GroupItemCode);i.data("default_action_code",t.DefaultActionCode);i.data("default_action_type_code",t.DefaultActionTypeCode);i.data("context_menu_code",t.ContextMenuCode);r=t.ContextMenuCode;!$q.isNullOrWhiteSpace(r)&&this._contextMenuManagerComponent&&(u=this._contextMenuManagerComponent.getContextMenu(r),$q.isNullOrEmpty(u)&&(f=this._treeComponent.element,u=this._contextMenuManagerComponent.createContextMenu(r,String.format("treeContextMenu_{0}",r),{targetElements:f,allowManualShowing:!0}),u.addMenuItemsToMenu(!1),f=null,u=null))},_extendNodeElements:function(n,t){var i=this,r=$q.toJQuery(n);jQuery.each(t,function(n,t){var u=i.getNode(t.NodeCode,r);i._extendNodeElement(u,t)})},executeAction:function(n,t){var i=this.getNode(n),r,e,o,f;if(!$q.isNullOrEmpty(i))if(r=$a.getBackendActionByCode(t),r){if(e=r.ActionType.Code,o=r.IsCustom,!o&&e==ACTION_TYPE_CODE_REFRESH){this.refreshNode(i);return}var s=$q.toBoolean(i.data("is_folder"),!1),h=$q.toBoolean(i.data("is_group"),!1),u=new Quantumart.QP8.BackendActionParameters({entityTypeCode:i.data("entity_type_code"),entityId:s?0:i.data("entity_id"),entityName:i.data("entity_name"),parentEntityId:$q.toInt(i.data("parent_entity_id"),0),isGroup:h});u.correct(r);f=$a.getEventArgsFromActionWithParams(r,u);this.notify(EVENT_TYPE_TREE_MENU_ACTION_EXECUTING,f);u=null;f=null}else alert($l.Common.ajaxDataReceivingErrorMessage)},onActionExecuted:function(n){var i=n.get_entityTypeCode(),t=n.get_actionTypeCode(),u=n.get_parentEntityId(),h=n.get_entityId(),r;if(n.get_isRemoving()||t==ACTION_TYPE_CODE_COPY||n.get_isSaved()||n.get_isUpdated())if(r=Quantumart.QP8.BackendEntityType.getEntityTypeByCode(i),r){var f=this.generateNodeCode(i,r.Id,u,!0),e=this.generateNodeCode(i,h,u,!1),o=n.get_context()&&n.get_context().orderChanged,c=n.get_context()&&n.get_context().groupChanged,s={loadChildNodes:!0};t==ACTION_TYPE_CODE_REMOVE?this.removeNodeOrRefreshParent(e,f,s):t==ACTION_TYPE_CODE_MULTIPLE_REMOVE||t==ACTION_TYPE_CODE_COPY||n.get_isSaved()||n.get_isUpdated()&&(o||c)?this.refreshNode(f):n.get_isUpdated()&&!o&&this.refreshNode(e,s)}else alert($l.Common.ajaxDataReceivingErrorMessage)},_onDataBinding:function(n){this.addNodesToParentNode(n,0)},_onNodeClicking:function(n){var i=jQuery(n.currentTarget),t=jQuery(i.closest(".t-item")[0]);if(!this._treeComponent.shouldNavigate(i))return t=null,n.preventDefault(),!1;this.isTreeBusy()?(t=null,n.preventDefault()):(t.find(this.NODE_WRAPPER_SELECTOR).removeClass(this.NODE_HOVER_CLASS_NAME),this.highlightNode(t),!t.data("is_folder")&&this._isNodeCollapsed(t)&&this._treeComponent.nodeToggle(null,t,!0),$q.isNullOrWhiteSpace(t.data("default_action_code"))||this.executeAction(t,t.data("default_action_code")));t=null},_onContextMenu:function(n){var i=jQuery(n.currentTarget),r=jQuery(i.closest(".t-item")[0]),u=r.data("context_menu_code"),t;this.isTreeBusy()||(!$q.isNullOrWhiteSpace(u)&&this._contextMenuManagerComponent&&(t=this._contextMenuManagerComponent.getContextMenu(u),$q.isNullOrEmpty(t)||(t.showMenu(n,i.parent().parent().get(0)),t=null)),i=null);r=null;n.preventDefault()},_onNodeContextMenuShowing:function(n,t,i){var u=i.get_menu(),r=jQuery(i.get_targetElement());$q.isNullOrEmpty(r)||$q.isNullOrEmpty(u)||u.tuneMenuItems(r.data("entity_id"));r=null},_onNodeContextMenuItemClicking:function(n,t,i){var r=jQuery(i.get_menuItem());$q.isNullOrEmpty(r)||(this._contextMenuActionCode=r.data("action_code"));r=null},_onNodeContextMenuHidden:function(n,t,i){var r=jQuery(i.get_targetElement());$q.isNullOrEmpty(this._contextMenuActionCode)||(this.executeAction(r,this._contextMenuActionCode),this._contextMenuActionCode=null);r=null},dispose:function(){var n=jQuery("#"+this._treeElementId),t;n.delegate(this.NODE_NEW_CLICKABLE_SELECTORS,"click",this._onNodeClickingHandler);this._contextMenuManagerComponent!=null&&(t=this._contextMenuManagerComponent.getContextMenuEventType(),n.undelegate(this.NODE_NEW_CLICKABLE_SELECTORS,t,this._onContextMenuHandler),this._contextMenuManagerComponent.detachObserver(EVENT_TYPE_CONTEXT_MENU_SHOWING,this._onNodeContextMenuShowingHandler),this._contextMenuManagerComponent.detachObserver(EVENT_TYPE_CONTEXT_MENU_ITEM_CLICKING,this._onNodeContextMenuItemClickingHandler),this._contextMenuManagerComponent.detachObserver(EVENT_TYPE_CONTEXT_MENU_HIDDEN,this._onNodeContextMenuHiddenHandler),this._contextMenuManagerComponent=null);this._onDataBindingHandler=null;this._onNodeClickingHandler=null;this._onContextMenuHandler=null;this._onNodeContextMenuShowingHandler=null;this._onNodeContextMenuItemClickingHandler=null;this._onNodeContextMenuHiddenHandler=null;Quantumart.QP8.BackendTreeMenu.callBaseMethod(this,"dispose")}};Quantumart.QP8.BackendTreeMenu.getTreeMenuNode=function(n,t,i,r,u,f,e,o,s){$q.getJsonFromUrl("GET",CONTROLLER_URL_TREE_MENU+"GetNode",{entityTypeCode:n,entityId:t,parentEntityId:i,isFolder:r,isGroup:u,groupItemCode:f,loadChildNodes:e},!1,!1,o,s)};Quantumart.QP8.BackendTreeMenu.getTreeMenuChildNodesList=function(n,t,i){$q.getJsonFromUrl("GET",CONTROLLER_URL_TREE_MENU+"GetChildNodesList",{entityTypeCode:n.entityTypeCode,parentEntityId:n.parentEntityId,isFolder:n.isFolder,isGroup:n.isGroup,groupItemCode:n.groupItemCode},!1,!1,t,i)};Quantumart.QP8.BackendTreeMenu.getSubTreeToEntity=function(n,t,i,r){$q.getJsonFromUrl("GET",CONTROLLER_URL_TREE_MENU+"GetSubTreeToEntity",{entityTypeCode:n,parentEntityId:t,entityId:i},!1,!1,r,function(n){result=null;$q.processGenericAjaxError(n)})};Quantumart.QP8.BackendTreeMenu.registerClass("Quantumart.QP8.BackendTreeMenu",Quantumart.QP8.BackendTreeBase);