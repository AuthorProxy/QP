var EVENT_TYPE_ACTION_PERMISSIONS_TREE_EXECUTING="OnActionPermissionsTreeExecuting";Quantumart.QP8.BackendActionPermissionTree=function(n){Quantumart.QP8.BackendActionPermissionTree.initializeBase(this,[n]);this._onDataBindingHandler=jQuery.proxy(this._onDataBinding,this);this._onContextMenuHandler=jQuery.proxy(this._onContextMenu,this);this._onNodeContextMenuShowingHandler=jQuery.proxy(this._onNodeContextMenuShowing,this);this._onNodeContextMenuItemClickingHandler=jQuery.proxy(this._onNodeContextMenuItemClicking,this);this._onNodeContextMenuHiddenHandler=jQuery.proxy(this._onNodeContextMenuHidden,this)};Quantumart.QP8.BackendActionPermissionTree.prototype={_userId:null,_groupId:null,_currentNodeId:-1,_contextMenuActionCode:"",_entityTypeContextMenuComponent:null,_actionContextMenuComponent:null,_onContextMenuHandler:null,_onNodeContextMenuItemClickingHandler:null,_onNodeContextMenuHiddenHandler:null,_onNodeContextMenuShowingHandler:null,set_userId:function(n){this._userId=n},get_userId:function(){return this._userId},set_groupId:function(n){this._groupId=n},get_groupId:function(){return this._groupId},initialize:function(){var n,t;Quantumart.QP8.BackendActionPermissionTree.callBaseMethod(this,"initialize");n=jQuery.proxy(function(n){var t=new Quantumart.QP8.BackendContextMenu(n,String.format("{0}_{1}_ContextMenu",this._treeElementId,n),{targetElements:this._treeElement,allowManualShowing:!0});return t.initialize(),t.addMenuItemsToMenu(!1),t.attachObserver(EVENT_TYPE_CONTEXT_MENU_SHOWING,this._onNodeContextMenuShowingHandler),t.attachObserver(EVENT_TYPE_CONTEXT_MENU_ITEM_CLICKING,this._onNodeContextMenuItemClickingHandler),t.attachObserver(EVENT_TYPE_CONTEXT_MENU_HIDDEN,this._onNodeContextMenuHiddenHandler),t},this);this._entityTypeContextMenuComponent=n(CONTEXT_MENU_CODE_ENTITY_TYPE_PERMISSION_NODE);this._actionContextMenuComponent=n(CONTEXT_MENU_CODE_ACTION_PERMISSION_NODE);t=this._entityTypeContextMenuComponent.getContextMenuEventType();jQuery(this._treeElement).on(t,this.NODE_NEW_CLICKABLE_SELECTORS,this._onContextMenuHandler)},executeAction:function(n,t){var i,r;if(!$q.isNullOrEmpty(n)){if(i=$a.getBackendActionByCode(t),!i){alert($l.Common.ajaxDataReceivingErrorMessage);return}i.ActionType.Code==ACTION_TYPE_CODE_REFRESH?this.refreshNode(n):(r=$a.getEventArgsFromAction(i),r.set_entityId(0),r.set_parentEntityId(this._getNodeId(n)),this.notify(EVENT_TYPE_ACTION_PERMISSIONS_TREE_EXECUTING,r),r=null);i=null}},refreshPermissionNode:function(n,t){var i="",u,r;n==ENTITY_TYPE_CODE_ENTITY_TYPE_PERMISSION?i=Quantumart.QP8.Enums.ActionPermissionTreeNodeType.EntityTypeNode:n==ENTITY_TYPE_CODE_ACTION_PERMISSION&&(i=Quantumart.QP8.Enums.ActionPermissionTreeNodeType.ActionNode);u=this._converToItemValue({NodeType:i,Id:t});r=this.getNode(u);r&&this.refreshNode(r)},_onDataBinding:function(n){this.addNodesToParentNode(n,0)},_onContextMenu:function(n){var t=jQuery(n.currentTarget),i=jQuery(t.closest(".t-item")[0]),r;this._currentNodeId=this.getNodeValue(i);r=this._getNodeType(i);r==Quantumart.QP8.Enums.ActionPermissionTreeNodeType.EntityTypeNode?this._entityTypeContextMenuComponent.showMenu(n,t.get(0)):r==Quantumart.QP8.Enums.ActionPermissionTreeNodeType.ActionNode&&this._actionContextMenuComponent.showMenu(n,t.get(0));t=null;i=null;n.preventDefault()},_onNodeContextMenuShowing:function(n,t,i){var r=i.get_menu(),u=jQuery(i.get_targetElement());$q.isNullOrEmpty(u)||$q.isNullOrEmpty(r)||r.tuneMenuItems(this._getNodeId(u.closest(".t-item")));u=null;r=null},_onNodeContextMenuItemClicking:function(n,t,i){var r=jQuery(i.get_menuItem());$q.isNullOrEmpty(r)||(this._contextMenuActionCode=r.data("action_code"));r=null},_onNodeContextMenuHidden:function(){var n=this.getNode(this._currentNodeId);$q.isNullOrEmpty(this._contextMenuActionCode)||(this.executeAction(n,this._contextMenuActionCode),this._contextMenuActionCode=null,this._currentNodeId=null);n=null},addNodesToParentNode:function(n,t,i){var r=this.getNode(n),f=this.isRootNode(r),o=this._getNodeType(r),e,u;f?r.empty():e=this._getNodeId(r);this._showAjaxLoadingIndicatorForNode(r);u=this;this._loadChildNodes(e).done(function(n){if(!u._stopDeferredOperations&&n)if(n.Type==ACTION_MESSAGE_TYPE_ERROR)Quantumart.QP8.BackendActionExecutor.showResult(n);else{var t=u._convertToTreeViewItems(n);u._renderChildNodes(r,t,f,!1,!0);$q.clearArray(t);u._hideAjaxLoadingIndicatorForNode(r);u._extendNodeElements(r,n);$q.callFunction(i)}}).fail(function(n){u._stopDeferredOperations||($q.processGenericAjaxError(n),$q.callFunction(i))})},_refreshNodeInner:function(n,t,i){var o=this.isRootNode(n),u,f,e,r;o?this.addNodesToParentNode(n,0,i):(u=this._getNodeType(n),u==Quantumart.QP8.Enums.ActionPermissionTreeNodeType.EntityTypeNode?f=this._getNodeId(n):u==Quantumart.QP8.Enums.ActionPermissionTreeNodeType.ActionNode&&(e=this._getNodeId(n),$parentNode=this.getParentNode(n),f=this._getNodeId($parentNode)),this._showAjaxLoadingIndicatorForNode(n),r=this,this._loadNode(f,e).done(function(t){var u,f;r._stopDeferredOperations||t&&(u=r._convertToTreeViewItem(t),r._renderNode(n,u,!1),u=null,t.Children&&(f=r._convertToTreeViewItems(t.Children),r._renderChildNodes(n,f,!1,!1),$q.clearArray(f)),r._hideAjaxLoadingIndicatorForNode(n),r._extendNodeElement(n,t),t.Children&&r._extendNodeElements(n,t.Children),$q.callFunction(i))}).fail(function(n){r._stopDeferredOperations||($q.processGenericAjaxError(n),$q.callFunction(i))}))},_getNodeId:function(n){var t=null,i;return $q.isNullOrEmpty(n)||(i=this.getNodeValue(n),i!=this.ROOT_NODE_CODE&&(t=n.data("node_id"))),t},_getNodeType:function(n){var t=null,i;return $q.isNullOrEmpty(n)||(i=this.getNodeValue(n),i!=this.ROOT_NODE_CODE&&(t=n.data("node_type"))),t},_convertToTreeViewItems:function(n){if(jQuery.isArray(n))return jQuery.map(n,jQuery.proxy(this._convertToTreeViewItem,this))},_convertToTreeViewItem:function(n){var t="";return t=n.IconUrl.left(7).toLowerCase()!=="http://"?THEME_IMAGE_FOLDER_URL_SMALL_ICONS+n.IconUrl:n.IconUrl,{Value:this._converToItemValue(n),Text:n.Text,ImageUrl:t,LoadOnDemand:n.HasChildren,Expanded:!1,Enabled:!0}},_converToItemValue:function(n){if(n)return n.NodeType+"-"+n.Id},_extendNodeElement:function(n,t){var i=this.getNode(n);$q.isNullOrEmpty(i)||(i.data("node_type",t.NodeType),i.data("node_id",t.Id))},_extendNodeElements:function(n,t){var i=this,r=$q.toJQuery(n);jQuery.each(t,function(n,t){var u=i.getNode(i._converToItemValue(t),r);i._extendNodeElement(u,t)})},_loadChildNodes:function(n){return $q.getJsonFromUrl("POST",CONTROLLER_URL_ACTION_PERMISSION_TREE+"GetTreeNodes",{entityTypeId:n,userId:this._userId,groupId:this._groupId},!0,!1)},_loadNode:function(n,t){return $q.getJsonFromUrl("POST",CONTROLLER_URL_ACTION_PERMISSION_TREE+"GetTreeNode",{entityTypeId:n,actionId:t,userId:this._userId,groupId:this._groupId},!0,!1)},dispose:function(){var n=jQuery.proxy(function(n){n&&(n.detachObserver(EVENT_TYPE_CONTEXT_MENU_SHOWING,this._onNodeContextMenuShowingHandler),n.detachObserver(EVENT_TYPE_CONTEXT_MENU_ITEM_CLICKING,this._onNodeContextMenuItemClickingHandler),n.detachObserver(EVENT_TYPE_CONTEXT_MENU_HIDDEN,this._onNodeContextMenuHiddenHandler),n.dispose())},this);jQuery(this.NODE_NEW_CLICKABLE_SELECTORS,this._treeElement).off();n(this._entityTypeContextMenuComponent);this._entityTypeContextMenuComponent=null;n(this._actionContextMenuComponent);this._actionContextMenuComponent=null;this._onNodeContextMenuShowingHandler=null;this._onNodeContextMenuItemClickingHandler=null;this._onNodeContextMenuHiddenHandler=null;Quantumart.QP8.BackendActionPermissionTree.callBaseMethod(this,"dispose")}};Quantumart.QP8.BackendActionPermissionTree.registerClass("Quantumart.QP8.BackendActionPermissionTree",Quantumart.QP8.BackendTreeBase);