var EVENT_TYPE_LIBRARY_DATA_BOUND="OnLibraryDataBound",EVENT_TYPE_LIBRARY_ACTION_EXECUTING="OnLibraryActionExecuting",EVENT_TYPE_LIBRARY_ENTITY_SELECTED="OnLibraryEntitySelected",EVENT_TYPE_LIBRARY_ENTITY_REMOVED="OnLibraryEntityRemoved",EVENT_TYPE_LIBRARY_REQUEST_VIEW_TYPE_CODE="OnLibraryRequestViewTypeCode",EVENT_TYPE_LIBRARY_RESIZED="OnLibraryResized";Quantumart.QP8.BackendLibrary=function(n,t,i,r,u,f){Quantumart.QP8.BackendLibrary.initializeBase(this);this._libraryGroupCode=n;this._libraryElementId=t;this._libraryElement=jQuery("#"+t).get(0);this._fileContainers={};this._fileContainers[VIEW_TYPE_CODE_DETAILS]=jQuery("."+this.LIBRARY_GRID_CONTAINER_CLASS_NAME,this._libraryElement);this._fileContainers[VIEW_TYPE_CODE_LIST]=jQuery("."+this.LIBRARY_LIST_CONTAINER_CLASS_NAME,this._libraryElement);this._fileContainers[VIEW_TYPE_CODE_THUMBNAILS]=jQuery("."+this.LIBRARY_THUMBNAILS_CONTAINER_CLASS_NAME,this._libraryElement);this._parentEntityId=i;this._actionCode=r;this._folderEntityTypeCode=r==ACTION_CODE_SITE_LIBRARY?ENTITY_TYPE_CODE_SITE_FOLDER:ENTITY_TYPE_CODE_CONTENT_FOLDER;this._fileEntityTypeCode=r==ACTION_CODE_SITE_LIBRARY?ENTITY_TYPE_CODE_SITE_FILE:ENTITY_TYPE_CODE_CONTENT_FILE;this._folderId=u.folderId;this._splitterId=u.splitterId;this._folderTreeId=u.folderTreeId;this._fileGridId=u.fileGridId;this._allowMultipleSelection=u.allowMultipleSelection;this._uploaderType=u.uploaderType;u.filterFileTypeId&&(this._filterFileTypeId=u.filterFileTypeId,this._isFilterFileTypeIdDefined=!0);f.viewTypeCode&&(this._viewTypeCode=f.viewTypeCode);f.zIndex&&(this._zIndex=f.zIndex);this._allowUpload=$q.toBoolean(u.allowUpload,!1);this._fileTypeListElement=jQuery("."+this.LIBRARY_FILE_TYPE_LIST_CLASS_NAME,this._libraryElement);this._fileNameSearchElement=jQuery("."+this.LIBRARY_FILE_NAME_FILTER_CLASS_NAME,this._libraryElement);this._filterApplyButtonElement=jQuery("."+this.LIBRARY_FILTER_BUTTON_CLASS_NAME,this._libraryElement);this._filterResetButtonElement=jQuery("."+this.LIBRARY_RESET_FILTER_BUTTON_CLASS_NAME,this._libraryElement);this._filterFormElement=jQuery("."+this.LIBRARY_FILTER_FORM_CLASS_NAME,this._libraryElement)};Quantumart.QP8.BackendLibrary.prototype={_libraryGroupCode:"",_libraryElementId:"",_libraryElement:null,_fileTypeListElement:null,_fileNameSearchElement:null,_filterApplyButtonElement:null,_filterResetButtonElement:null,_filterFormElement:null,_fileGridContainer:null,_entityTypeCode:"",_parentEntityId:0,_actionCode:"",_libraryManager:null,_fileContainers:null,_viewTypeCode:VIEW_TYPE_CODE_LIST,_folderId:0,_filterFileTypeId:"",_allowUpload:!1,_isFilterFileTypeIdDefined:!1,_filterFileName:"",_folderPath:"",_libraryPath:"",_folderUrl:"",_allowMultipleSelection:!0,_uploaderType:Quantumart.QP8.Enums.UploaderType.Silverlight,LIBRARY_TREE_CONTAINER_CLASS_NAME:"l-tree",LIBRARY_GRID_CONTAINER_CLASS_NAME:"l-grid",LIBRARY_LIST_CONTAINER_CLASS_NAME:"l-list",LIBRARY_THUMBNAILS_CONTAINER_CLASS_NAME:"l-thumb",LIBRARY_FILE_TYPE_LIST_CLASS_NAME:"l-fileTypeList",LIBRARY_FILE_NAME_FILTER_CLASS_NAME:"l-fileNameSearch",LIBRARY_FILTER_BUTTON_CLASS_NAME:"l-filterButton",LIBRARY_RESET_FILTER_BUTTON_CLASS_NAME:"l-resetFilterButton",LIBRARY_FILTER_FORM_CLASS_NAME:"l-filterForm",LIBRARY_PHYSICAL_PATH_CLASS_NAME:"l-physical-path",LIBRARY_VIRTUAL_PATH_CLASS_NAME:"l-virtual-path",set_libraryManager:function(n){this._libraryManager=n},get_libraryManager:function(){return this._libraryManager},set_folderId:function(n){this._folderId=n},get_folderId:function(){return this._folderId},set_viewTypeCode:function(n){this._viewTypeCode=n},get_viewTypeCode:function(){return this._viewTypeCode},initialize:function(){var t,n;jQuery(this._libraryElement).closest(".documentWrapper").addClass("libraryWrapper");this._folderTree=Quantumart.QP8.BackendEntityTreeManager.getInstance().createTree(this._folderTreeId,this._folderEntityTypeCode,this._parentEntityId,this._actionCode,{contextMenuCode:this._folderEntityTypeCode,rootEntityId:this._folderId,zIndex:this._zIndex});this._folderTree.attachObserver(EVENT_TYPE_ENTITY_TREE_ENTITY_SELECTED,jQuery.proxy(this._onFolderSelectedHandler,this));this._folderTree.attachObserver(EVENT_TYPE_ENTITY_TREE_ACTION_EXECUTING,jQuery.proxy(this._onActionExecutingHandler,this));this._folderTree.oneTimeObserver(EVENT_TYPE_ENTITY_TREE_DATA_BOUND,jQuery.proxy(this._onFolderTreeLoaded,this));this._folderTree.initialize();this._splitter=new Quantumart.QP8.BackendSplitter(this._splitterId,{firstPaneWidth:250,minFirstPaneWidth:50,maxFirstPaneWidth:250,stateCookieName:"FolderTreeSize"});this._splitter.attachObserver(EVENT_TYPE_SPLITTER_RESIZED,jQuery.proxy(this._onSplitterResized,this));this._splitter.attachObserver(EVENT_TYPE_SPLITTER_INITIALIZED,jQuery.proxy(this._onSplitterResized,this));this._fileGrid=Quantumart.QP8.BackendEntityGridManager.getInstance().createGrid(this._fileGridId,this._fileEntityTypeCode,this._folderId,this._actionCode,{contextMenuCode:this._fileEntityTypeCode,autoLoad:!1,keyColumnName:"Name",allowMultipleRowSelection:this._allowMultipleSelection,zIndex:this._zIndex});this._fileGrid.attachObserver(EVENT_TYPE_ENTITY_GRID_ENTITY_SELECTED,jQuery.proxy(this._onFileSelectedHandler,this));this._fileGrid.attachObserver(EVENT_TYPE_ENTITY_GRID_DATA_BOUND,jQuery.proxy(this._onFileListDataBoundHandler,this));this._fileGrid.attachObserver(EVENT_TYPE_ENTITY_GRID_ACTION_EXECUTING,jQuery.proxy(this._onActionExecutingHandler,this));this._fileGrid.initialize();t={selectMode:this._allowMultipleSelection?FILE_LIST_SELECT_MODE_MULTIPLE:FILE_LIST_SELECT_MODE_SINGLE,zIndex:this._zIndex};this._fileList=new Quantumart.QP8.BackendFileList("#"+this._fileContainers[VIEW_TYPE_CODE_LIST].attr("id"),this._fileEntityTypeCode,this._actionCode,this._fileEntityTypeCode,FILE_LIST_MODE_NAME_LIST,t);this._fileList.attachObserver(EVENT_TYPE_FILE_LIST_SELECTED,jQuery.proxy(this._onFileSelectedHandler,this));this._fileList.attachObserver(EVENT_TYPE_FILE_LIST_DATA_BOUND,jQuery.proxy(this._onFileListDataBoundHandler,this));this._fileList.attachObserver(EVENT_TYPE_FILE_LIST_ACTION_EXECUTING,jQuery.proxy(this._onActionExecutingHandler,this));this._fileList.initialize();this._filePreviewList=new Quantumart.QP8.BackendFileList("#"+this._fileContainers[VIEW_TYPE_CODE_THUMBNAILS].attr("id"),this._fileEntityTypeCode,this._actionCode,this._fileEntityTypeCode,FILE_LIST_MODE_PREVIEW_LIST,t);this._filePreviewList.attachObserver(EVENT_TYPE_FILE_LIST_SELECTED,jQuery.proxy(this._onFileSelectedHandler,this));this._filePreviewList.attachObserver(EVENT_TYPE_FILE_LIST_DATA_BOUND,jQuery.proxy(this._onFileListDataBoundHandler,this));this._filePreviewList.attachObserver(EVENT_TYPE_FILE_LIST_ACTION_EXECUTING,jQuery.proxy(this._onActionExecutingHandler,this));this._filePreviewList.initialize();n="";this._isFilterFileTypeIdDefined===!0&&(n=LIBRARY_FILE_EXTENSIONS_DICTIONARY[""+this._filterFileTypeId]);this._allowUpload&&(this._uploaderType==Quantumart.QP8.Enums.UploaderType.Silverlight?this._uploader=new Quantumart.QP8.BackendSilverlightUploader(this._libraryElement,{background:"#EBF5FB",extensions:n}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.Html?this._uploader=new Quantumart.QP8.BackendHtmlUploader(this._libraryElement,{extensions:n}):this._uploaderType==Quantumart.QP8.Enums.UploaderType.PlUpload&&(this._uploader=new Quantumart.QP8.BackendPlUploader(this._libraryElement,{extensions:n})),this._uploader.attachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED,jQuery.proxy(this._onFileUploadedHandler,this)),this._uploader.initialize());this._loadFolderPath();this._updateFolderInfo();jQuery(this._filterApplyButtonElement).click(jQuery.proxy(this._onFilterChangedHandler,this));jQuery(this._filterResetButtonElement).click(jQuery.proxy(this._onFilterResetHandler,this));jQuery(this._filterFormElement).submit(jQuery.proxy(this._onFilterFormSubmittedHandler,this));jQuery(this._fileTypeListElement).change(jQuery.proxy(this._onFileTypeChangedHandler,this));this._isFilterFileTypeIdDefined&&(jQuery("option[value='"+this._filterFileTypeId+"']",this._fileTypeListElement).prop("selected",!0),jQuery(this._fileTypeListElement).prop("disabled",!0));this.resetCurrentFileList();this.showCurrentFileList()},onLoad:function(){this._splitter.initialize()},refreshLibrary:function(){},changeViewType:function(n){this._viewTypeCode=n;this.resetCurrentFileList();this.showCurrentFileList()},showCurrentFileList:function(){var i,n,t;for(i in this._fileContainers)n=this._fileContainers[i],n&&n.hide();t=this._fileContainers[this._viewTypeCode];t&&t.show()},resetCurrentFileList:function(){this._viewTypeCode==VIEW_TYPE_CODE_DETAILS?(this._fileGrid.set_parentEntityId(this._folderId),this._fileGrid.resetGrid({searchQuery:JSON.stringify({FileType:this._filterFileTypeId,FileNameFilter:this._filterFileName})})):this._viewTypeCode==VIEW_TYPE_CODE_LIST?this._fileList.rebind({pageNumber:0,folderId:this._folderId,fileTypeId:this._filterFileTypeId,fileNameFilter:this._filterFileName}):this._viewTypeCode==VIEW_TYPE_CODE_THUMBNAILS&&this._filePreviewList.rebind({pageNumber:0,folderId:this._folderId,fileTypeId:this._filterFileTypeId,fileNameFilter:this._filterFileName})},refreshCurrentFileList:function(){this._viewTypeCode==VIEW_TYPE_CODE_DETAILS?this._fileGrid.refreshGrid():this._viewTypeCode==VIEW_TYPE_CODE_LIST?this._fileList.rebind():this._viewTypeCode==VIEW_TYPE_CODE_THUMBNAILS&&this._filePreviewList.rebind()},resize:function(){this._splitter&&(this.notify(EVENT_TYPE_LIBRARY_RESIZED,{}),this._splitter.resize())},_onSplitterResized:function(){this.notify(EVENT_TYPE_LIBRARY_RESIZED,{});this._splitter.resize()},_onFolderSelectedHandler:function(n,t,i){var u=i.get_entities(),r;u.length>0&&(r=u[0].Id,this._folderId!=r&&(this._folderId=r,this._loadFolderPath(),this._updateFolderInfo(),this.resetCurrentFileList()))},_onFileSelectedHandler:function(n,t,i){i.set_context(this._libraryPath);this.notify(EVENT_TYPE_LIBRARY_ENTITY_SELECTED,i)},_onFileListDataBoundHandler:function(n,t,i){i.set_context(this._libraryPath);this.notify(EVENT_TYPE_LIBRARY_DATA_BOUND,i)},_onFilterChangedHandler:function(){this._filterFileTypeId=jQuery(this._fileTypeListElement).val();this._filterFileName=jQuery(this._fileNameSearchElement).val();this.resetCurrentFileList()},_onFilterResetHandler:function(){this._isFilterFileTypeIdDefined||jQuery("option[value='']",this._fileTypeListElement).prop("selected",!0);jQuery(this._fileNameSearchElement).val("");this._onFilterChangedHandler()},_onFilterFormSubmittedHandler:function(n){return n.preventDefault(),jQuery(this._filterApplyButtonElement).trigger("click"),!1},_onFileTypeChangedHandler:function(){jQuery(this._filterApplyButtonElement).trigger("click")},_onFileUploadedHandler:function(){this.refreshCurrentFileList()},_onActionExecutingHandler:function(n,t,i){var f=$a.getBackendActionByCode(i.get_actionCode()),r,u;f&&(r=new Quantumart.QP8.BackendActionParameters({eventArgs:i}),r.correct(f),u=$a.getEventArgsFromActionWithParams(f,r),u.set_context(this._libraryPath),this.notify(EVENT_TYPE_LIBRARY_ACTION_EXECUTING,u),r=null,u=null)},_onFolderTreeLoaded:function(){this._folderTree.selectRoot()},_loadFolderPath:function(){var t="",n;if(this._fileEntityTypeCode==ENTITY_TYPE_CODE_SITE_FILE)t=CONTROLLER_URL_SITE+"_FolderPath";else if(this._fileEntityTypeCode==ENTITY_TYPE_CODE_CONTENT_FILE)t=CONTROLLER_URL_CONTENT+"_FolderPath";else throw new Error("fileEntityTypeCode is unknown.");n=this;$q.getJsonFromUrl("GET",t,{folderId:this._folderId},!1,!1,function(t){t.success?(n._folderPath=t.path,n._folderUrl=t.url,n._uploader.set_folderPath(t.path),n._libraryPath=t.libraryPath):alert(t.message)},function(n){$q.processGenericAjaxError(n)})},_updateFolderInfo:function(){jQuery("."+this.LIBRARY_PHYSICAL_PATH_CLASS_NAME,this._libraryElement).html(this._folderPath);jQuery("."+this.LIBRARY_VIRTUAL_PATH_CLASS_NAME,this._libraryElement).html(this._folderUrl)},dispose:function(){Quantumart.QP8.BackendLibraryManager.getInstance().removeLibrary(this._libraryElementId);this._splitter&&(this._splitter.detachObserver(EVENT_TYPE_SPLITTER_RESIZED),this._splitter.detachObserver(EVENT_TYPE_SPLITTER_INITIALIZED),this._splitter.dispose(),this._splitter=null);this._folderTree&&(this._folderTree.detachObserver(EVENT_TYPE_ENTITY_TREE_ENTITY_SELECTED),this._folderTree.detachObserver(EVENT_TYPE_ENTITY_TREE_ACTION_EXECUTING),this._folderTree.detachObserver(EVENT_TYPE_ENTITY_TREE_DATA_BOUND),this._folderTree.dispose(),this._folderTree=null);this._fileGrid&&(this._fileGrid.detachObserver(EVENT_TYPE_ENTITY_GRID_DATA_BOUND),this._fileGrid.detachObserver(EVENT_TYPE_ENTITY_GRID_ENTITY_SELECTED),this._fileGrid.detachObserver(EVENT_TYPE_ENTITY_GRID_ACTION_EXECUTING),this._fileGrid.dispose(),this._fileGrid=null);this._fileList&&(this._fileList.detachObserver(EVENT_TYPE_FILE_LIST_SELECTED),this._fileList.detachObserver(EVENT_TYPE_FILE_LIST_DATA_BOUND),this._fileList.detachObserver(EVENT_TYPE_FILE_LIST_ACTION_EXECUTING),this._fileList.dispose(),this._fileList=null);this._filePreviewList&&(this._filePreviewList.detachObserver(EVENT_TYPE_FILE_LIST_SELECTED),this._filePreviewList.detachObserver(EVENT_TYPE_FILE_LIST_DATA_BOUND),this._filePreviewList.detachObserver(EVENT_TYPE_FILE_LIST_ACTION_EXECUTING),this._filePreviewList.dispose(),this._filePreviewList=null);this._uploader&&(this._uploader.detachObserver(EVENT_TYPE_LIBRARY_FILE_UPLOADED),this._uploader.dispose(),this._uploader=null);this._fileContainers[VIEW_TYPE_CODE_DETAILS]=null;this._fileContainers[VIEW_TYPE_CODE_LIST]=null;this._fileContainers[VIEW_TYPE_CODE_THUMBNAILS]=null;this._fileContainers=null;this._libraryElement=null;jQuery(this._filterApplyButtonElement).unbind("click");jQuery(this._filterResetButtonElement).unbind("click");jQuery(this._filterFormElement).unbind("submit");jQuery(this._fileTypeListElement).unbind("change");this._fileTypeListElement=null;this._filterApplyButtonElement=null;this._filterResetButtonElement=null;this._fileNameSearchElement=null;this._filterFormElement=null;$q.collectGarbageInIE();Quantumart.QP8.BackendLibrary.callBaseMethod(this,"dispose")}};Quantumart.QP8.BackendLibrary.generateActionUrl=function(n,t){var r="",i;return t&&(i=new $.telerik.stringBuilder,i.cat(APPLICATION_ROOT_URL),i.cat("/Library/"),i.cat(n),i.cat("/"+(t.id||0)),i.cat("?fileName="+t.fileName),i.cat("&isVersion="+(t.isVersion||!1)),i.catIf("&entityTypeCode="+t.entityTypeCode,t.entityTypeCode),i.catIf("&entityId="+t.entityId,t.entityId),i.catIf("&actionTypeCode="+t.actionTypeCode,t.actionTypeCode),r=i.string()),r};Quantumart.QP8.BackendLibrary.registerClass("Quantumart.QP8.BackendLibrary",Quantumart.QP8.Observable);