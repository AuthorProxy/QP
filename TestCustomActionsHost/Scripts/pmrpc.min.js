pmrpc=self.pmrpc=function(){function ft(){for(var n=[],t=0;t<36;t++)n[t]="0123456789ABCDEF"[Math.floor(Math.random()*16)];return n[14]="4",n[19]="89AB"[Math.floor(Math.random()*4)],n[8]=n[13]=n[18]=n[23]="-",n.join("")}function w(n){var t=n.replace(/([\^\$\.\+\?\=\!\:\|\\\/\(\)\[\]\{\}])/g,"\\$1");return"^"+t.replace(/\*/g,".*")+"$"}function et(n,t){for(var f=n.whitelist,e=n.blacklist,o=!1,s=!1,u,r,i=0;i<f.length;++i)if(r=w(f[i]),t.match(r)){o=!0;break}for(u=0;i<e.length;++u)if(r=w(e[u]),t.match(r)){s=!0;break}return o&&!s}function b(n,t,i,r){var e,u,o,f,h,s;if(!(i instanceof Array)){for(e=n.toString(),u=e.substring(e.indexOf("(")+1,e.indexOf(")")),u=u===""?[]:u.split(", "),o={},f=0;f<u.length;f++)o[u[f]]=f;h=[];for(s in i)if(typeof o[s]!="undefined")h[o[s]]=i[s];else throw"No such param!";i=h}return typeof r!="undefined"&&(i=i.concat(r)),n.apply(t,i)}function a(n){return"pmrpc."+JSON.stringify(n)}function ot(n){return JSON.parse(n.substring(6))}function k(){var n={};return n.jsonrpc="2.0",n}function d(n,t,i){var r=k();return r.method=n,r.params=t,typeof i!="undefined"&&(r.id=i),r}function i(n,t,i){var r={};return r.code=n,r.message=t,r.data=i,r}function n(n,t,i){var r=k();return r.id=i,typeof n=="undefined"||n===null?r.result=t==="undefined"?null:t:r.error=n,r}function h(n){return n.publicProcedureName in s?!1:(r[n.publicProcedureName]={publicProcedureName:n.publicProcedureName,procedure:n.procedure,context:n.procedure.context,isAsync:typeof n.isAsynchronous!="undefined"?n.isAsynchronous:!1,acl:typeof n.acl!="undefined"?n.acl:{whitelist:["*"],blacklist:[]}},!0)}function g(n){return n in s?!1:(delete r[n],!0)}function nt(n){return r[n]}function f(n){var t=n.event,u=n.source,f=typeof u!="undefined"&&u!==null,i,r;t.data.indexOf("pmrpc.")===0&&(i=ot(t.data),typeof i.method!="undefined"?(r={data:t.data,source:f?u:t.source,origin:f?"*":t.origin,shouldCheckACL:!f},response=st(i,r),response!==null&&v(r.source,response,r.origin)):tt(i))}function st(t,r){var u,f,o,s;if(t.jsonrpc!=="2.0")return n(i(-32600,"Invalid request.","The recived JSON is not a valid JSON-RPC 2.0 request."),null,null);if(u=t.id,f=nt(t.method),typeof f!="undefined")if(!r.shouldCheckACL||et(f.acl,r.origin))try{return f.isAsync?(o=function(t){v(r.source,n(null,t,u),r.origin)},b(f.procedure,f.context,t.params,[o,r]),null):(s=b(f.procedure,f.context,t.params,[r]),typeof u=="undefined"?null:n(null,s,u))}catch(e){return typeof u=="undefined"?null:e==="No such param!"?n(i(-32602,"Invalid params.",e.description),null,u):n(i(-1,"Application error.",e.description),null,u)}else return typeof u=="undefined"?null:n(i(-2,"Application error.","Access denied on server."),null,u);else return typeof u=="undefined"?null:n(i(-32601,"Method not found.","The requestd remote procedure does not exist or is not available."),null,u)}function tt(n){var r=n.id,i=t[r];if(typeof i!="undefined"&&i!==null)if(delete t[r],typeof n.error=="undefined")i.onSuccess({destination:i.destination,publicProcedureName:i.publicProcedureName,params:i.params,status:"success",returnValue:n.result});else i.onError({destination:i.destination,publicProcedureName:i.publicProcedureName,params:i.params,status:"error",description:n.error.message+" "+n.error.data})}function it(n){var r,i,u;if(n.retries&&n.retries<0)throw new Exception("number of retries must be 0 or higher");if(r=[],typeof n.destination=="undefined"||n.destination===null||n.destination==="workerParent")r=[{context:null,type:"workerParent"}];else if(n.destination==="publish")r=ut();else if(n.destination instanceof Array)for(i=0;i<n.destination.length;i++)n.destination[i]==="workerParent"?r.push({context:null,type:"workerParent"}):typeof n.destination[i].frames!="undefined"?r.push({context:n.destination[i],type:"window"}):r.push({context:n.destination[i],type:"worker"});else typeof n.destination.frames!="undefined"?r.push({context:n.destination,type:"window"}):r.push({context:n.destination,type:"worker"});for(i=0;i<r.length;i++)u={destination:r[i].context,destinationDomain:typeof n.destinationDomain=="undefined"?["*"]:typeof n.destinationDomain=="string"?[n.destinationDomain]:n.destinationDomain,publicProcedureName:n.publicProcedureName,onSuccess:typeof n.onSuccess!="undefined"?n.onSuccess:function(){},onError:typeof n.onError!="undefined"?n.onError:function(){},retries:typeof n.retries!="undefined"?n.retries:5,timeout:typeof n.timeout!="undefined"?n.timeout:500,status:"requestNotSent"},isNotification=typeof n.onError=="undefined"&&typeof n.onSuccess=="undefined",params=typeof n.params!="undefined"?n.params:[],callId=ft(),t[callId]=u,u.message=isNotification?d(n.publicProcedureName,params):d(n.publicProcedureName,params,callId),c(callId)}function v(n,t,i){if(typeof n=="undefined"||n===null)self.postMessage(a(t));else{if(typeof n.frames!="undefined")return n.postMessage(a(t),i);n.postMessage(a(t))}}function c(r){var u=t[r],f;if(typeof u!="undefined")if(u.retries<=-1)tt(n(i(-4,"Application error.","Destination unavailable."),null,r));else{if(u.status==="requestSent")return;if(u.retries===0||u.status==="available")for(u.status="requestSent",u.retries=-1,t[r]=u,f=0;f<u.destinationDomain.length;f++)v(u.destination,u.message,u.destinationDomain[f],u),self.setTimeout(function(){c(r)},u.timeout);else u.status="pinging",u.retries=u.retries-1,it({destination:u.destination,publicProcedureName:"receivePingRequest",onSuccess:function(n){n.returnValue===!0&&typeof t[r]!="undefined"&&(t[r].status="available",c(r))},params:[u.publicProcedureName],retries:0,destinationDomain:u.destinationDomain}),t[r]=u,self.setTimeout(function(){c(r)},u.timeout/u.retries)}}function u(n,t,i,r){"addEventListener"in n?n.addEventListener(t,i,r):n.attachEvent("on"+t,i)}function e(n,t,i){return function(r){var u={event:r,source:t,destinationType:i};n(u)}}function ht(n){return typeof nt(n)!="undefined"}function ct(){var n=[],t,r,i;if(typeof window!="undefined")for(n.push({context:window.top,type:"window"}),t=0;typeof n[t]!="undefined";t++)for(r=n[t],i=0;i<r.context.frames.length;i++)n.push({context:r.context.frames[i],type:"window"});else n.push({context:this,type:"workerParent"});return n}function lt(){return l}function ut(){var n=ct(),t=lt();return n.concat(t)}function at(){var n=[],t=typeof this.frames!="undefined"?window.location.protocol+"//"+window.location.host+(window.location.port!==""?":"+window.location.port:""):"";for(publicProcedureName in r)if(publicProcedureName in s)continue;else n.push({publicProcedureName:r[publicProcedureName].publicProcedureName,acl:r[publicProcedureName].acl,origin:t});return n}function vt(n){function o(n,t){for(var i=0;i<n.length;i++)n[i].origin.match(f)&&n[i].publicProcedureName.match(e)&&u.push({publicProcedureName:n[i].publicProcedureName,destination:t,procedureACL:n[i].acl,destinationOrigin:n[i].origin})}var t=null,i;if(typeof n.destination=="undefined")for(t=ut(),i=0;i<t.length;i++)t[i]=t[i].context;else t=n.destination;var f=typeof n.origin=="undefined"?".*":n.origin,e=typeof n.publicProcedureName=="undefined"?".*":n.publicProcedureName,r=t.length,u=[];pmrpc.call({destination:t,destinationDomain:"*",publicProcedureName:"getRegisteredProcedures",onSuccess:function(t){r--;o(t.returnValue,t.destination);r===0&&n.callback(u)},onError:function(){r--;r===0&&n.callback(u)}})}var o,rt,y,p,l;if(typeof JSON=="undefined"||typeof JSON.stringify=="undefined"||typeof JSON.parse=="undefined")throw"pmrpc requires the JSON library";if(typeof this.postMessage=="undefined"&&typeof this.onconnect=="undefined")throw"pmrpc requires the HTML5 cross-document messaging and worker APIs";var r={},t={},s={};if("window"in this)o=e(f,null,"window"),u(this,"message",o,!1);else if("onmessage"in this)o=e(f,this,"worker"),u(this,"message",o,!1);else if("onconnect"in this)rt=function(n){var t=e(f,n.ports[0],"sharedWorker");u(n.ports[0],"message",t,!1);n.ports[0].start()},u(this,"connect",rt,!1);else throw"Pmrpc must be loaded within a browser window or web worker.";return y=this.Worker,this.nonPmrpcWorker=y,p=this.SharedWorker,this.nonPmrpcSharedWorker=p,l=[],this.Worker=function(n){var t=new y(n),i;return l.push({context:t,type:"worker"}),i=e(f,t,"worker"),u(t,"message",i,!1),t},this.SharedWorker=function(n,t){var i=new p(n,t),r;return l.push({context:i,type:"sharedWorker"}),r=e(f,i.port,"sharedWorker"),u(i.port,"message",r,!1),i.postMessage=function(n,t){return i.port.postMessage(n,t)},i.port.start(),i},h({publicProcedureName:"receivePingRequest",procedure:ht}),h({publicProcedureName:"getRegisteredProcedures",procedure:at}),s={getRegisteredProcedures:null,receivePingRequest:null},{register:h,unregister:g,call:it,discover:vt}}();